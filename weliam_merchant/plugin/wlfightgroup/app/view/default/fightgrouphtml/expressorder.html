{php include wl_template('common/header');}
<link rel="stylesheet" href="{URL_MODULE}plugin/wlfightgroup/app/resource/css/orderdetail.css"></link>
<div class="page-group">
    <div class="page page-current" id="page-order-detail">
	    <header class="bar bar-nav">
	    	<a class="button button-link button-nav pull-left back" href="{php echo app_url('order/userorder/orderlist',array('status'=>'all'))}"><span class="icon icon-left"></span>返回</a>
	    	<h1 class="title">订单详情</h1>
	  	</header>
    	
		<div class="content" style="overflow-x: hidden;">
			<div id="nav" class="nav">
			    <p class="nav-wrap">
			        <span class="j-nav-item j-nav-detail nav-item nav-choose">订单详情</span>
			        <span class="j-nav-item j-nav-status nav-item ">订单状态</span>
			        <label class="j-nav-bottomline nav-bottomline"></label>
			    </p>
			</div>
			<div id="order-status" style="display: none">
			    <div class="timeline">
		            <div class="timeline-item">
		                <img class="timeline-logo" src="http://p1.meituan.net/xianfu/8adf62cf3cb75f1a4b21380be10af9fa2048.png">
		                <div class="timeline-block">
		                    <i class="timline-block-arrow"></i>
		                    <p class="timeline-title">订单已提交<span class="timeline-time">{php echo date('m-d H:i', $order['createtime']);}</span></p>
		                    <p class="timeline-sub">等待用户支付订单</p>
		                </div>
		            </div>
		            {if $order['paytime']}
		            <div class="timeline-connect timeline-connect-21"></div>
		            <div class="timeline-item">
		                <img class="timeline-logo" src="http://p0.meituan.net/xianfu/794ec85889844239f32764861c56660a2048.png">
		                <div class="timeline-block">
		                    <i class="timline-block-arrow"></i>
		                    <p class="timeline-title">支付成功<span class="timeline-time">{php echo date('m-d H:i', $order['paytime']);}</span></p>
		                    <p class="timeline-sub"></p>
		                </div>
		            </div>
		            {/if}
		            {if $group['status'] == 1}
		            <div class="timeline-connect timeline-connect-12"></div>
		            <div class="timeline-item">
		                <span class="icon icon-check timeline-logo" style="background-color: #FFD705;text-align: center;border-radius:11px;color: #7C5609;"></span>
		                <div class="timeline-block">
		                    <i class="timline-block-arrow"></i>
		                    <p class="timeline-title">组团中<span class="timeline-time">{php echo date('m-d H:i', $order['paytime']);}</span></p>
		                    <p class="timeline-sub">正在组团中，请召唤小伙伴</p>
		                </div>
		            </div>
		            {/if}
		            {if $group['status'] == 2}
		            <div class="timeline-connect timeline-connect-12"></div>
		            <div class="timeline-item">
		                <span class="icon icon-check timeline-logo" style="background-color: #FFD705;text-align: center;border-radius:11px;color: #7C5609;"></span>
		                <div class="timeline-block">
		                    <i class="timline-block-arrow"></i>
		                    <p class="timeline-title">组团成功<span class="timeline-time">{php echo date('m-d H:i', $group['successtime']);}</span></p>
		                    <p class="timeline-sub">小伙伴们好给力</p>
		                </div>
		            </div>
		            {/if}
		            {if $group['status'] == 3}
		            <div class="timeline-connect timeline-connect-12"></div>
		            <div class="timeline-item">
		                <span class="icon icon-check timeline-logo" style="background-color: #FFD705;text-align: center;border-radius:11px;color: #7C5609;"></span>
		                <div class="timeline-block">
		                    <i class="timline-block-arrow"></i>
		                    <p class="timeline-title">组团失败<span class="timeline-time">{php echo date('m-d H:i', $group['failtime']);}</span></p>
		                    <p class="timeline-sub">再来一次试试吧</p>
		                </div>
		            </div>
		            {/if}
		            {if $record && empty($order['neworderflag'])}
		            <div class="timeline-connect timeline-connect-12"></div>
		            <div class="timeline-item">
		                <img class="timeline-logo" src="http://p0.meituan.net/xianfu/a34001a981214d535bd8466da34490502048.png">
		                <div class="timeline-block">
		                    <i class="timline-block-arrow"></i>
		                    <p class="timeline-title">请到店消费<span class="timeline-time">{php echo date('m-d H:i', $record['createtime']);}</span></p>
		                    <p class="timeline-sub">请到商家店铺核销消费</p>
		                </div>
		            </div>
		            {/if}
					{if $order['neworderflag']}
					<div class="timeline-connect timeline-connect-12"></div>
					<div class="timeline-item">
						<img class="timeline-logo" src="http://p0.meituan.net/xianfu/a34001a981214d535bd8466da34490502048.png">
						<div class="timeline-block">
							<i class="timline-block-arrow"></i>
							<p class="timeline-title">请到店消费<span class="timeline-time">{php echo date('m-d H:i', $smalls[0]['createtime']);}</span></p>
							<p class="timeline-sub">请到商家店铺核销消费</p>
						</div>
					</div>
					{/if}
		            {if $order['status'] == 9}
		            <div class="timeline-connect timeline-connect-12"></div>
		            <div class="timeline-item">
		                <img class="timeline-logo" src="http://p0.meituan.net/xianfu/a34001a981214d535bd8466da34490502048.png">
		                <div class="timeline-block">
		                    <i class="timline-block-arrow"></i>
		                    <p class="timeline-title">订单已过期<span class="timeline-time">{php echo date('m-d H:i', $order['estimatetime']);}</span></p>
		                    <p class="timeline-sub">请用户联系管理员</p>
		                </div>
		            </div>
		            {/if}
		            {if $express['sendtime']}
		            <div class="timeline-connect timeline-connect-12"></div>
		            <div class="timeline-item">
		                <img class="timeline-logo" src="http://p0.meituan.net/xianfu/a34001a981214d535bd8466da34490502048.png">
		                <div class="timeline-block">
		                    <i class="timline-block-arrow"></i>
		                    <p class="timeline-title">商家发货<span class="timeline-time">{php echo date('m-d H:i', $express['sendtime']);}</span></p>
		                    <p class="timeline-sub">商品已发货，请耐心等待哦</p>
		                </div>
		            </div>
		            {/if}
		            {if $express['receivetime']}
		            <div class="timeline-connect timeline-connect-12"></div>
		            <div class="timeline-item">
		                <span class="icon icon-emoji timeline-logo" style="background-color: #FFD705;text-align: center;border-radius:11px;color: #7C5609;"></span>
		                <div class="timeline-block">
		                    <i class="timline-block-arrow"></i>
		                    <p class="timeline-title">订单已完成<span class="timeline-time">{php echo date('m-d H:i',$express['receivetime']);}</span></p>
		                    <p class="timeline-sub">感谢您的信任，祝您生活愉快</p>
		                </div>
		            </div>
		            {/if}
		            {if ($order['status'] == 2 || $order['status'] == 3) && empty($express['receivetime'])}
		            <div class="timeline-connect timeline-connect-12"></div>
		            <div class="timeline-item">
		                <span class="icon icon-emoji timeline-logo" style="background-color: #FFD705;text-align: center;border-radius:11px;color: #7C5609;"></span>
		                <div class="timeline-block">
		                    <i class="timline-block-arrow"></i>
		                    <p class="timeline-title">订单已完成<span class="timeline-time"></span></p>
		                    <p class="timeline-sub">感谢您的信任，祝您生活愉快</p>
		                </div>
		            </div>
		            {/if}
		            {if $order['refundtime']}
		            <div class="timeline-connect timeline-connect-12"></div>
		            <div class="timeline-item">
		                <span class="icon iconfont icon-refund timeline-logo" style="background-color: #FFD705;text-align: center;border-radius:11px;color: #7C5609;"></span>
		                <div class="timeline-block">
		                    <i class="timline-block-arrow"></i>
		                    <p class="timeline-title">订单已退款<span class="timeline-time">{php echo date('m-d H:i',$order['refundtime']);}</span></p>
		                    <p class="timeline-sub">感谢您的信任，祝您生活愉快</p>
		                </div>
		            </div>
		            {/if}
		             {if $order['status'] == 5}
		            <div class="timeline-connect timeline-connect-12"></div>
		            <div class="timeline-item">
		                <span class="icon iconfont icon-refund timeline-logo" style="background-color: #FFD705;text-align: center;border-radius:11px;color: #7C5609;"></span>
		                <div class="timeline-block">
		                    <i class="timline-block-arrow"></i>
		                    <p class="timeline-title">订单已取消<span class="timeline-time"></span></p>
		                    <p class="timeline-sub">您可以选购其他商品，祝您生活愉快</p>
		                </div>
		            </div>
		            {/if}
			    </div>
			    
			    <div class="bottombar-placeholder"></div>
			
			</div>
			
			<div id="order-detail">
			    <div class="orderregion">
			        <a class="status-hotelname" href="#">
			            <i class="icon1-detail status-hotelname-icon"></i>
			            <label class="status-hotelname-name">{$merchant['storename']}</label>
			            <i class="icon-arrow-right-thin status-hotelname-back"></i>
			        </a>
			    </div>
			    
			    <div class="orderregion orderregion-top">
			        <ul class="orderregion-entries">
			            <li class="orderregion-entry">
			                <span class="name text-overflow-ellipsis-2">{$goods['name']}</span>
			                <span class="price"></span>
			                <span class="price" >×{$order['num']}</span>
			            </li>
			        </ul>
			    </div>
			
			    <div class="orderregion">
			        <ul class="orderregion-entries">
			        	{if $order['spec']}
			        	<li class="orderregion-entry order-other-price">
			                <span class="name text-overflow-ellipsis-2">规格</span>
			                <span class="price">&nbsp;{$order['spec']}</span>
			            </li>
			            {/if}
			            <li class="orderregion-entry order-other-price">
			                <span class="name text-overflow-ellipsis-2">货价</span>
			                <span class="price">￥&nbsp;{$order['goodprice']}</span>
			            </li>
			            {if $express}
			            <li class="orderregion-entry order-other-price">
			                <span class="name text-overflow-ellipsis-2">运费</span>
			                <span class="price">￥&nbsp;{$express['expressprice']}</span>
			            </li>
			            {/if}
			            {if $order['card_type'] == 1 || $order['card_type'] == 3}
			            <li class="orderregion-entry order-other-price">
			                <span class="name text-overflow-ellipsis-2">VIP减免</span>
			                <span class="price">￥&nbsp;-{$order['vipdk']}</span>
			            </li>
			            {/if}
			            {if $order['card_type'] == 2 || $order['card_type'] == 3}
			            <li class="orderregion-entry order-other-price">
			                <span class="name text-overflow-ellipsis-2">积分抵扣</span>
			                <span class="price">￥&nbsp;-{$order['creditdk']}</span>
			            </li>
			            {/if}
			            <li class="orderregion-entry order-total-price">
			                <span class="name text-overflow-ellipsis-2">合计</span>
			                <span class="price">￥&nbsp;{$order['price']}</span>
			            </li>
			        </ul>
			    </div>
				{if $express}
		       	<div class="orderregion">
			        <h1 class="orderregion-title">
			            <i class="icon1-detail status-detail-icon"></i>
			            <label class="status-name">配送信息</label>
			        </h1>
			        <ul class="orderregion-entries-compact">
			            <li class="orderregion-entry-compact">
			                <span class="label">收货人：</span>{$express['name']}&nbsp; {$express['tel']}
			            </li>
			            <li class="orderregion-entry-compact">
			                <span class="label">收货地址：</span>{$express['address']}
			            </li>
			            {if $express['expressname']}
			            <li class="orderregion-entry-compact">
			                <span class="label">快递公司：</span>{$express['expressname']}
			            </li>
			            <li class="orderregion-entry-compact">
			                <span class="label">快递单号：</span>{$express['expresssn']}
			            </li>
			            {/if}
			            {if $order['buyremark']}
			            <li class="orderregion-entry-compact">
			                <span class="label">买家备注：</span>{$order['buyremark']}
			            </li>
			            {/if}
			        </ul>
			    </div>
		       	{/if}
		       	{if $record && $order['status'] == 1 && empty($order['neworderflag'])}
				<div class="orderregion">
					<h1 class="orderregion-title" style="position: relative;">
						<i class="icon1-detail status-detail-icon"></i>
						<label class="status-name">核销信息</label>
						{if $merchant['verkey'] && $record['usetimes']}
						<i style="position: absolute;right: 15px;bottom: 0px;font-size: 20px;color: orange;" class="icon iconfont icon-command"></i>
						{/if}
					</h1>
					<ul class="orderregion-entries-compact">
						{if $record['usetimes']}
						<li style="text-align: center;" class="orderregion-entry-compact">
							<img style="width: 5rem;height: 5rem;" src="{$qrcodeimg}" id="qrimg"/>
						</li>
						{if $order['estimatetime']}
						<li class="orderregion-entry-compact">
							<span class="label">截止时间：</span>{php echo date('Y-m-d H:i',$order['estimatetime'])}
						</li>
						{/if}
						<li class="orderregion-entry-compact">
							<span class="label">核销码：</span>{$record['qrcode']}
						</li>
						{/if}
						<li class="orderregion-entry-compact">
							<span class="label">剩余次数：</span>{$record['usetimes']}
						</li>
						{if $record['usedtime']}
						{loop $record['usedtime'] $k $usedtime}
						{if count($record['usedtime']) == 1}
						<li class="orderregion-entry-compact">
							<span class="label">使用时间：</span>{php echo date('Y-m-d H:i:s',$usedtime['time'])}
						</li>
						{else}
						<li class="orderregion-entry-compact">
							<span class="label">第{php echo $k+1}次使用：</span>{php echo date('Y-m-d H:i:s',$usedtime['time'])}
						</li>
						{/if}
						{/loop}
						{/if}
						{if $order['buyremark']}
						<li class="orderregion-entry-compact">
							<span class="label">买家备注：</span>{$order['buyremark']}
						</li>
						{/if}
					</ul>
				</div>
				{/if}
				<!--小订单-->
				{if $order['neworderflag'] && $order['status'] == 1}
				<div class="orderregion">
					<h1 class="orderregion-title" style="position: relative;">
						<i class="icon1-detail status-detail-icon"></i>
						<label class="status-name">核销信息</label>
						{if $merchant['verkey']}
						<i style="position: absolute;right: 15px;bottom: 0px;font-size: 20px;color: orange;" class="icon iconfont icon-command"></i>
						{/if}
					</h1>
					<ul class="orderregion-entries-compact">
						{if $usetimes}
						<li style="text-align: center;" class="orderregion-entry-compact">
							<img style="width: 5rem;height: 5rem;" src="{$qrcodeimg}" id="qrimg"/>
						</li>
						{if $order['estimatetime']}
						<li class="orderregion-entry-compact">
							<span class="label">截止时间：</span>{php echo date('Y-m-d H:i',$order['estimatetime'])}
						</li>
						{/if}
						<li class="orderregion-entry-compact">
							<span class="label">核销码：</span>
							{loop $smalls $small}
								<br/>{$small['checkcode']} {if $small['status'] == 2 }(已核销){/if}
							{/loop}
						</li>
						{/if}
						<li class="orderregion-entry-compact">
							<span class="label">剩余次数：</span>{$usetimes}
						</li>
						{loop $smalls $k $usedtime}
						{if $usedtime['status'] == 2}
						<li class="orderregion-entry-compact">
							<span class="label">{$usedtime['checkcode']}使用时间：</span>{php echo date('Y-m-d H:i:s',$usedtime['hexiaotime'])}
						</li>
						{/if}
						{/loop}
						{if $order['buyremark']}
						<li class="orderregion-entry-compact">
							<span class="label">买家备注：</span>{$order['buyremark']}
						</li>
						{/if}
					</ul>
				</div>
				{/if}


			    <div class="orderregion">
			        <h1 class="orderregion-title">
			            <i class="icon1-detail status-detail-icon"></i>
			            <label class="status-name">订单详情</label>
			        </h1>
			        <ul class="orderregion-entries-compact">
			            <li class="orderregion-entry-compact">
			                <span class="label">订单号码：</span>{$order['orderno']}
			            </li>
			            <li class="orderregion-entry-compact">
			                <span class="label">下单时间：</span>{php echo date('Y-m-d H:i:s', $order['createtime']);}
			            </li>
			            <li class="orderregion-entry-compact">
			                <span class="label">支付方式：</span>{if $order['paytype'] == 4}货到付款{else if $order['paytype'] == 2}微信支付{else if $order['paytype'] == 3}他人代付{else if $order['paytype'] == 1}余额支付{/if}
			            </li>
			            {if $order['remark']}
			            <li class="orderregion-entry-compact">
			                <span class="label">备注：</span>{$order['remark']}
			            </li>
			            {/if}
			        </ul>
			    </div>
			    {if !empty($coupon) }
			    <div class="orderregion">
			        <h1 class="orderregion-title">
			            <i class="icon1-detail status-detail-icon"></i>
			            <label class="status-name">优惠券详情</label>
			        </h1>
			        <ul class="orderregion-entries-compact">
			            <li class="orderregion-entry-compact">
			                <span class="label">优惠券名称：</span>{$coupon['name']}
			            </li>
			            <li class="orderregion-entry-compact">
			                <span class="label">优惠券减免：</span>￥{$coupon['cash']}
			            </li>
			            <li class="orderregion-entry-compact">
			                <span class="label">优惠券说明：</span>{$coupon['description']}
			            </li>
			        </ul>
			    </div>
				{/if}
			    <div class="buy-again-placeholder"></div>
			    </div>
			    <div class="bottombar-down">
			        <div class="bottombar">
			    		<div class="bottombar-icon"><i style="font-size: 30px;position: relative;top: -7px;color: orange;" class="icon iconfont icon-info"></i></div>
			        	<div class="bottombar-main">
						    <div class="bottombar-buttonwrap bottombar-buttonwrap-3">
						    	{if $order['status'] == 4 && $order['expressid']}
						    	<button id="btn-received" class="combtn bottombar-btn-red" exid = "{$express['id']}" oid="{$order['id']}">确认收货</button>
						        <button id="btn-hasten" class="combtn bottombar-btn-dark">查看物流</button>
						    	{elseif $order['status'] == 2}
						    	<button id="btn-comment" class="combtn bottombar-btn-light">去评论</button>
						        {else}
						        <button class="combtn bottombar-btn-red" style="width: 50%;" onclick="location.href='{php echo app_url('wlfightgroup/fightapp/fightindex');}'">查看更多拼团商品</button>
						        {/if}
								{if $order['fightgroupid']}
		                        <button class="combtn bottombar-btn-dark" onclick="location.href='{php echo app_url('wlfightgroup/fightapp/groupdetail', array('id'=>$order['fightgroupid']));}'" style="margin-right: 10px;">查看团详情</button>
		                        {/if}
						    </div>
			            </div>
			        </div>
			    </div>
			</div>
		</div>
	</div>
</div>
<div class="popup popup-qrcode">
  	<div class="content" style="background: #eee;">
    	<div class="list-block cards-list">
	      <ul>
	        <li class="card" style="border-radius: .2rem;">
	          <div class="card-header"><h3 class="font-size-14">核销订单提货凭证</h3></div>
	          <div class="card-content">
	            <div class="card-content-inner">
			        <div class="voucher-code">
			            <p>提货码：{$order['hexiaoma']}</p>
			            <p>
			                <img src="{TG_URL}data/qrcode/{$_W['uniacid']}/{$order['orderno']}.png" onerror="javascript:this.src='http://qr.topscan.com/api.php?w=300&text={$qrcodeurl}';">
			            </p>
			        </div>
			        <div class="voucher-address font-size-14">
			            <!--<p>提货地址：{$order['address']}</p>-->
			            <p>到店时间：尽快到店提货</p>
			        </div>
			        <div class="voucher-goods-info font-size-14">
			            <p>商品信息：{$goods['gname']} </p>
			            {if $order['optionname']}
			             <p>商品规格：{$order['optionname']} </p>
			            {/if}
			            <p>购买数量：{$order['gnum']} {$order['unit']}</p>
				        <p>实付金额：{$order['pay_price']}元</p>
				        </div>
				    </div>
	          </div>
	        </li>
	      </ul>
	    </div>
	    <div class="weui_btn_area">
        	<a class="weui_btn weui_btn_warn close-popup">关闭</a>
    	</div>
  	</div>
</div>
<script>
	$(document).on('click','#btn-received',function(){
		var orderid = $(this).attr('oid');
		var exid = $(this).attr('exid');
//		alert(orderid+"|"+exid);
		$.confirm('是否确认收货？',
	        function () {
	          	$.post("{php echo app_url('wlfightgroup/fightapp/receipt')}",{orderid:orderid,exid:exid},function(d){
					if(d.status == 1){
					    $.toast('确认收货成功！');
					    setTimeout(function () {
							location.href = "{php echo app_url('wlfightgroup/fightapp/expressorder')}&"+'orderid='+orderid;
						}, 1000);
					}else{
						$.toast(d.result);
					}
				},"json");
	        }
	    );
	});
	$(document).on('click','.icon-command', function () {
	  $.prompt('请输入核销密码', function (value) {
	      $.post("{php echo app_url('wlfightgroup/fightapp/hexiaokey',array('sid'=>$merchant['id'],'orderid'=>$id))}",{verkey:value},function(d){
//	      	alert(JSON.stringify(d));
	      	if(!d.result){
	 			$.toast(d.msg);
//	      		location.href = "{php echo app_url('order/userorder/orderlist',array('status'=>2))}";
				location.reload();
	      	}else{
	      		$.toast(d.msg);
	      	}
	      },"json");
	   });
  	});
	$(document).on('click','#btn-hasten',function(){
	    $.showIndicator();
	    setTimeout(function () {
			location.href = "http://m.kuaidi100.com/index_all.html?type={$express['expressname']}&postid={$express['expresssn']}#input";
		}, 1000);
	});
	$(document).on('click','#btn-comment',function(){
	    $.showIndicator();
	   location.href = "{php echo app_url('order/comment/add')}&orderid={$id}";
	});
	$(".j-nav-status").bind('click', function() {
		$('.j-nav-status').addClass('nav-choose');
		$('.j-nav-detail').removeClass('nav-choose');
		$('.j-nav-bottomline').removeClass('nav-bottomline').addClass('nav-bottomlineright');
		$('#order-status').show();
		$('#order-detail').hide();
	});
	$(".j-nav-detail").bind('click', function() {
		$('.j-nav-detail').addClass('nav-choose');
		$('.j-nav-status').removeClass('nav-choose');
		$('.j-nav-bottomline').removeClass('nav-bottomlineright').addClass('nav-bottomline');
		$('#order-status').hide();
		$('#order-detail').show();
	});
</script>
{php include wl_template('common/footer');}