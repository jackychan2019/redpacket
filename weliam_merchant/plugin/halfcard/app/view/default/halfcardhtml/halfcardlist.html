{php include wl_template('common/header');}
<link href="{URL_MODULE}plugin/halfcard/app/resource/css/halfcardlist.css" rel="stylesheet" />
<link href="{URL_MODULE}plugin/halfcard/app/resource/css/opencord.css" rel="stylesheet" />
<div class="page-group">
	<div class="page page-current" id="page-index">
		<div class="content halflist native-scroll infinite-scroll-bottom infinite-scroll">
			<section class="banner-header">
				<div class="swiper-container" id="banner_header">
					<div class="swiper-wrapper">
						{loop $advs $adv}
						<div class="swiper-slide" style="padding: 0;">
							<div class="banner-img">
								<a href="{$adv['link']}"><img style="width: 100%;" src="{php echo tomedia($adv['thumb'])}"/></a>
							</div>
						</div>
						{/loop}
					</div>
					<div class="swiper-pagination" id="banner_header_page"></div>
				</div>
			</section>
			
			<div class="buttons-main">
				<div class="buttons-tab">
					<a href="#tab1" type="1" class="tab-link button active">
						<text>特权折扣</text>
						<span></span>
					</a>
					<a href="#tab2" type="2" class="tab-link button">
						<text>商家大礼包</text>
						<span></span>
					</a>
				</div>
				<div class="tabs">
					<div id="tab1" class="tab active">
						<section id="choiceday" class="native-time main-sm">
							<ul>
								<li class="time-item active" dayflag = '-1'>
									<span>全部</span>
									<p>折扣</p>
								</li>
								<li class="time-item" dayflag = '0'>
									<span>今天</span>
									<p>{$day}</p>
								</li>
								<li class="time-item" dayflag = '1'>
									<span>明天</span>
									<p>{$day1}</p>
								</li>
								<li class="time-item" dayflag = '2'>
									<span>{if $week2 == 1}周一{else if $week2 == 2}周二{else if $week2 == 3}周三{else if $week2 == 4}周四{else if $week2 == 5}周五{else if $week2 == 6}周六{else if $week2 == 7}周日{/if}</span>
									<p>{$day2}</p>
								</li>
								<li class="time-item" dayflag = '3'>
									<span>{if $week3 == 1}周一{else if $week3 == 2}周二{else if $week3 == 3}周三{else if $week3 == 4}周四{else if $week3 == 5}周五{else if $week3 == 6}周六{else if $week3 == 7}周日{/if}</span>
									<p>{$day3}</p>
								</li>
								<li class="time-item" dayflag = '4'>
									<span>{if $week4 == 1}周一{else if $week4 == 2}周二{else if $week4 == 3}周三{else if $week4 == 4}周四{else if $week4 == 5}周五{else if $week4 == 6}周六{else if $week4 == 7}周日{/if}</span>
									<p>{$day4}</p>
								</li>
							</ul>
						</section>
						<section class="native-goodslist main-sm" style="padding-bottom: 0;">
							<div class="goods-header">
								<ul>
									<li class="type-item active" cateid = '0'>
										<a href="javascript:;">全部商家</a>
									</li>
									{loop $categorys $cate}
									<li class="type-item" cateid = "{$cate['id']}" >
										<a href="javascript:;">{$cate['name']}</a>
									</li>
									{/loop}
								</ul>
							</div>
							<div class="goods-main">
								<div class="storelist">
									
								</div>
							</div>
							<div class="weui-loadmore loading_more" style="display: none;">
					            <i class="weui-loading"></i>
					            <span class="weui-loadmore__tips">正在加载</span>
					        </div>
					        <div class="weui-loadmore weui-loadmore_line" style="display: none;">
					            <span class="weui-loadmore__tips" style="background-color: #EFEFF4;">暂无更多数据</span>
					        </div>
					    <input type="hidden" id="dayflag" value="-1" />
					    <input type="hidden" id="cateid" value="0" />  
					    <input type="hidden" id="typeid" value="1" />    
						</section>
					</div>
				</div>
			</div>
			<div onclick="toindex()" class="tab-main">
				<svg class="icon" style="width: 1rem; height: 1rem;vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1445"><path d="M938.550351 420.09687 544.85478 89.101317c-0.069585-0.058328-0.14224-0.11154-0.212848-0.170892-0.406253-0.339738-0.820692-0.666172-1.236154-0.99056-0.161682-0.12689-0.322341-0.254803-0.487094-0.378623-0.499373-0.379647-1.004887-0.74599-1.515516-1.105171-0.080841-0.057305-0.161682-0.11461-0.242524-0.170892-0.582261-0.404206-1.172709-0.793062-1.768273-1.170662-0.007163-0.00307-0.013303-0.007163-0.019443-0.011256-18.34788-11.58178-42.872436-10.219759-59.740616 4.069689L86.023724 420.09687c-20.579711 17.286712-22.661116 47.351448-4.685719 67.127863 17.975397 19.763113 49.254797 21.806655 69.822229 4.507664l33.921577-28.519544 0 279.198863c0 65.736167 55.638181 119.242801 124.005268 119.242801l73.90829 0c27.321252 0 49.471738-21.297049 49.471738-47.570435L432.467107 589.488839c0-13.265118 11.234879-24.078395 25.022906-24.078395l109.539812 0c13.814634 0 25.075095 10.813277 25.075095 24.078395l0 219.015156c0 3.255137 0.344854 6.499018 1.046842 9.702989l1.199315 5.579065c4.787026 22.049179 25.009603 37.867446 48.438199 37.867446l72.694649 0c68.38039 0 124.017548-53.506635 124.017548-119.242801l0-279.18863 33.909297 28.509311c9.383718 7.876388 21.00029 11.745509 32.555463 11.745509 13.762445 0 27.488051-5.502317 37.266765-16.253172C961.20942 467.448318 959.129039 437.382559 938.550351 420.09687z" p-id="1446"></path></svg>
				<span>返回首页</span>
			</div>
		</div>
	</div>
</div>
<script type="text/html" id="avtivelist">
	<ul>
		{{# for(var i = 0, len = d.length; i < len; i++){ }}
		<li class="goods-item"  onclick="todetail({{d[i].id}})">
			<div class="goods-img" style="background-image: url({{d[i].logo}});"></div>
			<div class="goods-info">
				<span><text>{{d[i].title}}</text><text class="sub-title">{{d[i].limit}}</text></span>
				<p>
					<text class="ellipsis">{{d[i].storename}}</text>
					<span><i>{{d[i].discount}}折</i></span>
				</p>
			</div>
		</li>
		{{# } }}
	</ul>
</script>
<script type="text/html" id="packagelist">
		<ul class="benefit-list">
		{{# for(var i = 0, len = d.length; i < len; i++){ }}
		<li>
			<a href="javascript:;" class="inner l-flex">
			<div class="pic" onclick="topackdetail({{d[i].id}})" style="background-image: url({{d[i].logo}});"></div>
			<div class="txt flex-box">
				<div class="info"  onclick="topackdetail({{d[i].id}})">
					<h3 class="tit">{{d[i].storename}}</h3>
					<span class="date ellipsis">{{d[i].limit}}</span>
				</div>
				<div id="getpack{{d[i].id}}" getflag = "{{d[i].getflag}}"  {{# if(d[i].getflag){ }} style="background-color:limegreen;border-color: limegreen;" {{# } }} class="btn getpacks" onclick="getpack({{d[i].id}})" >
					{{# if(d[i].getflag){ }}
					立即使用
					{{# }else{ }} 
					会员免费领取
					{{# } }}
				</div>
			</div>
			</a>
		</li>
		{{# } }}
		</ul>
</script>
<style>
	.common-no-con{
		position: relative;
		top: 0;
		height: auto;
		margin-top: 0;
	}
</style>

<script>
	var loading = false;
	var pindex = 1;
	var swiper = new Swiper('.swiper-container', {
		loop: true,
		speed:500,
	    autoplay: 3000,
	    autoplayDisableOnInteraction : false,
	    setWrapperSize:true,
	    pagination: '#banner_header_page',
	    paginationClickable: true
	});
	
	
	
	function getpack(packid){
		var getflag = $('#getpack'+packid).attr('getflag');
		if(getflag>0){
			location.href = "{php echo app_url('halfcard/halfcard_app/packagedetail')}&id="+packid;
		}else{
			$.post("{php echo app_url('halfcard/halfcard_app/getpackage')}",{packid:packid},function(d){
				$.toast(d.msg);
				if(!d.errno){
					$('#getpack'+packid).text('立即使用');
					$('#getpack'+packid).css('background-color','limegreen');
					$('#getpack'+packid).css('border-color','limegreen');
					$('#getpack'+packid).attr('getflag',1);
				}else if(d.errno == 2){
					setTimeout(toopen(),500);
				}
			}, 'json');
		}
	}
		
	
	function topackdetail(id){
		location.href = "{php echo app_url('halfcard/halfcard_app/packagedetail')}&id="+id;
	}
	
	$(function() {
		$(document).on("pageInit", "#page-index", function(e,id,page){
			function addItems(pindex) {
				if (loading) return;
				loading = true;
				var dayflag = $('#dayflag').val();
				var cateid = $('#cateid').val();
				var typeid = $('#typeid').val();
				if(dayflag == -1){
					dayflag = 0;
					var indexflag = 1;
				}else{
					var indexflag = 0;
				}
				$.post("{php echo app_url('halfcard/halfcard_app/getstore')}",{pindex:pindex,dayflag:dayflag,cateid:cateid,indexflag:indexflag,typeid:typeid},function(d){
//					alert(JSON.stringify(d));
					loading = false;
					if(d.length){
						if(typeid == 1){
							var gettpl1 = document.getElementById('avtivelist').innerHTML;
						}else{
							var gettpl1 = document.getElementById('packagelist').innerHTML;
						}
						laytpl(gettpl1).render(d, function(html){
						   $(".storelist").append(html);
						});
					}else if(pindex == 1){
						$(".storelist").html('<div class="common-no-con"><img src="{URL_APP_IMAGE}order_no_con.png" alt=""><p>暂无商户记录</p></div>');
					}else{
						$(".weui-loadmore_line").show();
						$(".loading_more").remove();
					}
				}, 'json');
				setTimeout(function() {
					$(".loading_more").hide();
				}, 500);
			}
			addItems(pindex);
			$(page).on('infinite', function() {
				if (loading) return;
				loading = true;
				$(".loading_more").show();
				setTimeout(function() {
					loading = false;
					pindex++;
					addItems(pindex);
					$.refreshScroller();
				}, 500);
			});
			
			$('.time-item').click(function(){
				$('.time-item').each(function(){
					$(this).removeClass('active');
				});
				$(this).addClass('active');
				var dayflag = $(this).attr('dayflag');
				$('#dayflag').val(dayflag);
				pindex = 1;
				$('.storelist').html('');
				$(".loading_more").show();
				$('.weui-loadmore_line').hide();
				setTimeout(function() {
					addItems(pindex);
					$.refreshScroller();
				}, 500);
			});
			
			$('.type-item').click(function(){
				$('.type-item').each(function(){
					$(this).removeClass('active');
				});
				$(this).addClass('active');
				var cateid = $(this).attr('cateid');
				$('#cateid').val(cateid);
				pindex = 1;
				$('.storelist').html('');
				$(".loading_more").show();
				setTimeout(function() {
					addItems(pindex);
					$.refreshScroller();
				}, 500);
			});
			
			$('.button').click(function(){
				$('.button').each(function(){
					$(this).removeClass('active');
				});
				$(this).addClass('active');
				var type = $(this).attr('type');
				$("#typeid").val(type);
				if(type == 1){
					$('#choiceday').show();
				}else{
					$('#choiceday').hide();
				}
				pindex = 1;
				if(loading){
					$.toast('加载中,请稍后');
				}else{
					$('.storelist').html('');
					$(".loading_more").show();
					$('.weui-loadmore_line').hide();
					setTimeout(function() {
						addItems(pindex);
						$.refreshScroller();
					}, 500);
				}
				
			});
			
		});
		$.init();
	});
	function toopen() {
		location.href = "{php echo app_url('halfcard/halfcardopen/open')}";
	}
	
	function toindex(){
		location.href = "{php echo app_url('dashboard/home/index')}";
	}
	
	function todetail(id){
		location.href = "{php echo app_url('halfcard/halfcard_app/halfcarddetail')}&id="+id;
	}
	

</script>
{php include wl_template('common/footer');}