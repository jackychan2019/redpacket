<?php
//dezend by http://www.sucaihuo.com/
class WlOrder_WeliamController
{
	public function orderlist()
	{
		global $_W;
		global $_GPC;
		$pindex = max(1, intval($_GPC['page']));
		$psize = 10;
		$where = ' where uniacid = ' . $_W['uniacid'] . ' and orderno != 666666';
		$where2 = ' where a.uniacid = ' . $_W['uniacid'] . ' and a.orderno != 666666';

		if (is_agent()) {
			$where .= ' and aid = ' . $_W['aid'];
			$where2 .= ' and a.aid = ' . $_W['aid'];
		}

		if ($_GPC['status']) {
			if ($_GPC['status'] == 'zero') {
				$where .= ' and status = 0';
				$where2 .= ' and a.status = 0';
			}
			else if (intval($_GPC['status']) == 10) {
				$where .= ' and applyrefund = 1 and status IN (1,8)';
				$where2 .= ' and a.applyrefund = 1 and a.status IN (1,8)';
			}
			else if (intval($_GPC['status']) == 11) {
				$where .= ' and status IN (1,2,3,4,6,8,9)';
				$where2 .= ' and a.status IN (1,2,3,4,6,8,9)';
			}
			else if (intval($_GPC['status']) == 12) {
				$where .= ' and status IN (2,3)';
				$where2 .= ' and a.status IN (2,3)';
			}
			else if (intval($_GPC['status']) == 13) {
				$where .= ' and status IN  (0,1,2,3,4,6,8,9)';
				$where2 .= ' and a.status IN  (0,1,2,3,4,6,8,9)';
			}
			else {
				$where .= ' and status = ' . $_GPC['status'] . ' ';
				$where2 .= ' and a.status = ' . $_GPC['status'] . ' ';
			}
		}

		if ($_GPC['paytype']) {
			$where .= ' and paytype = ' . $_GPC['paytype'] . ' ';
			$where2 .= ' and a.paytype = ' . $_GPC['paytype'] . ' ';
		}

		if ($_GPC['keyword']) {
			$keyword = $_GPC['keyword'];

			if ($_GPC['keywordtype'] == 1) {
				$where .= ' and orderno LIKE \'%' . $keyword . '%\'';
				$where2 .= ' and a.orderno LIKE \'%' . $keyword . '%\'';
			}
			else if ($_GPC['keywordtype'] == 3) {
				$where .= ' and mid = \'' . $keyword . '\'';
				$where2 .= ' and a.mid = \'' . $keyword . '\'';
			}
			else if ($_GPC['keywordtype'] == 4) {
				$where .= ' and sid = \'' . $keyword . '\'';
				$where2 .= ' and a.sid = \'' . $keyword . '\'';
			}
			else if ($_GPC['keywordtype'] == 5) {
				$params[':name'] = '%' . $keyword . '%';
				$members = pdo_fetchall('SELECT * FROM ' . tablename('wlmerchant_member') . (' WHERE uniacid = ' . $_W['uniacid'] . '  AND nickname LIKE :name'), $params);

				if ($members) {
					$mids = '(';

					foreach ($members as $key => $v) {
						if ($key == 0) {
							$mids .= $v['id'];
						}
						else {
							$mids .= ',' . $v['id'];
						}
					}

					$mids .= ')';
					$where .= ' and mid IN ' . $mids;
					$where2 .= ' and a.mid IN ' . $mids;
				}
			}
			else if ($_GPC['keywordtype'] == 6) {
				$params[':name'] = '%' . $keyword . '%';
				$members = pdo_fetchall('SELECT * FROM ' . tablename('wlmerchant_member') . (' WHERE uniacid = ' . $_W['uniacid'] . ' AND mobile LIKE :name'), $params);

				if ($members) {
					$mids = '(';

					foreach ($members as $key => $v) {
						if ($key == 0) {
							$mids .= $v['id'];
						}
						else {
							$mids .= ',' . $v['id'];
						}
					}

					$mids .= ')';
					$where .= ' and mid IN ' . $mids;
					$where2 .= ' and a.mid IN ' . $mids;
				}
			}
			else if ($_GPC['keywordtype'] == 7) {
				$params[':name'] = '%' . $keyword . '%';
				$members = pdo_fetchall('SELECT * FROM ' . tablename('wlmerchant_merchantdata') . (' WHERE uniacid = ' . $_W['uniacid'] . ' AND storename LIKE :name'), $params);

				if ($members) {
					$mids = '(';

					foreach ($members as $key => $v) {
						if ($key == 0) {
							$mids .= $v['id'];
						}
						else {
							$mids .= ',' . $v['id'];
						}
					}

					$mids .= ')';
					$where .= ' and sid IN ' . $mids;
					$where2 .= ' and a.sid IN ' . $mids;
				}
			}
			else if ($_GPC['keywordtype'] == 8) {
				$smorder = pdo_get(PDO_NAME . 'smallorder', array('checkcode' => $keyword), array('orderid', 'plugin'));

				if ($smorder) {
					if ($smorder['plugin'] == 'rush') {
						$where .= ' AND id = ' . $smorder['orderid'] . ' ';
						$where2 .= ' AND a.id = 0';
					}
					else {
						$where .= ' AND id = 0 ';
						$where2 .= ' AND a.id = ' . $smorder['orderid'];
					}
				}
				else {
					$where .= ' AND checkcode = ' . $keyword . ' ';
					$where2 .= ' AND (f.qrcode = ' . $keyword . ' OR g.qrcode = ' . $keyword . ' OR `c`.concode = ' . $keyword . ' OR b.qrcode = ' . $keyword . ') ';
				}
			}
			else if ($_GPC['keywordtype'] == 9) {
				$keyword = '\'%' . $keyword . '%\'';
				$where .= ' AND mobile like ' . $keyword . ' ';
				$where2 .= ' AND a.mobile like ' . $keyword . ' ';
			}
			else {
				if ($_GPC['keywordtype'] == 10) {
					$params[':name'] = '%' . $keyword . '%';
					$members = pdo_fetchall('SELECT * FROM ' . tablename('wlmerchant_merchantdata') . (' WHERE uniacid = ' . $_W['uniacid'] . ' AND salesmid LIKE :name'), $params);

					if ($members) {
						$mids = '(';

						foreach ($members as $key => $v) {
							if ($key == 0) {
								$mids .= $v['id'];
							}
							else {
								$mids .= ',' . $v['id'];
							}
						}

						$mids .= ')';
						$where .= ' and sid IN ' . $mids;
						$where2 .= ' and a.sid IN ' . $mids;
					}
				}
			}
		}

		if (!empty($_GPC['time_limit']) && $_GPC['timetype']) {
			$starttime = strtotime($_GPC['time_limit']['start']);
			$endtime = strtotime($_GPC['time_limit']['end']);

			if ($_GPC['timetype'] == 1) {
				$where .= ' and createtime > ' . $starttime . ' and createtime < ' . $endtime;
				$where2 .= ' and a.createtime > ' . $starttime . ' and a.createtime < ' . $endtime;
			}
			else {
				$where .= ' and paytime > ' . $starttime . ' and paytime < ' . $endtime;
				$where2 .= ' and a.paytime > ' . $starttime . ' and a.paytime < ' . $endtime;
			}
		}

		if (empty($starttime) || empty($endtime)) {
			$starttime = strtotime('-1 month');
			$endtime = time();
		}

		if ($_GPC['plugin']) {
			$plugin = $_GPC['plugin'];

			if ($plugin == 'rush') {
				$where2 .= ' AND  a.plugin IN (\'null\') ';
			}
			else {
				$where2 .= ' AND  a.plugin = \'' . $plugin . '\' ';
				$where .= ' and orderno = 00000 ';
			}
		}
		else {
			$where2 .= ' AND  a.plugin IN (\'wlfightgroup\',\'groupon\',\'coupon\',\'bargain\') ';
		}

		if ($_GPC['keywordtype'] == 2 && $_GPC['keyword']) {
			$where .= ' and activityid = ' . $keyword . ' ';
			$where2 .= ' and  a.fkid = ' . $keyword . ' ';
		}

		if ($_GPC['fightgroupid']) {
			$where2 .= ' and  a.fightgroupid = ' . $_GPC['fightgroupid'] . ' ';
		}

		if ($_GPC['export']) {
			$this->export($where, $where2);
		}

		$total1 = pdo_fetchcolumn('SELECT COUNT(a.id) FROM ' . tablename(PDO_NAME . 'order') . ' a LEFT JOIN ' . tablename(PDO_NAME . 'fightgroup_userecord') . ' f ON a.id = f.orderid AND a.plugin = \'wlfightgroup\'' . ' LEFT JOIN ' . tablename(PDO_NAME . 'groupon_userecord') . ' g ON a.id = g.orderid AND a.plugin = \'groupon\'' . ' LEFT JOIN ' . tablename(PDO_NAME . 'member_coupons') . ' `c` ON a.orderno = `c`.orderno AND a.plugin = \'coupon\'' . ' LEFT JOIN ' . tablename(PDO_NAME . 'bargain_userlist') . (' b ON a.id = b.orderid AND a.plugin = \'bargain\' ' . $where2));
		$total2 = pdo_fetchcolumn('SELECT COUNT(id) FROM ' . tablename(PDO_NAME . 'rush_order') . (' ' . $where));
		$total = $total1 + $total2;
		$goodtotal1 = pdo_fetchcolumn('SELECT SUM(a.num) FROM ' . tablename(PDO_NAME . 'order') . ' a LEFT JOIN ' . tablename(PDO_NAME . 'fightgroup_userecord') . ' f ON a.id = f.orderid AND a.plugin = \'wlfightgroup\'' . ' LEFT JOIN ' . tablename(PDO_NAME . 'groupon_userecord') . ' g ON a.id = g.orderid AND a.plugin = \'groupon\'' . ' LEFT JOIN ' . tablename(PDO_NAME . 'member_coupons') . ' `c` ON a.orderno = `c`.orderno AND a.plugin = \'coupon\'' . ' LEFT JOIN ' . tablename(PDO_NAME . 'bargain_userlist') . (' b ON a.id = b.orderid AND a.plugin = \'bargain\' ' . $where2));
		$goodtotal2 = pdo_fetchcolumn('SELECT SUM(num) FROM ' . tablename(PDO_NAME . 'rush_order') . (' ' . $where));
		$goodtotal = $goodtotal1 + $goodtotal2;
		$allprice1 = pdo_fetchcolumn('SELECT SUM(a.price) FROM ' . tablename(PDO_NAME . 'order') . ' a LEFT JOIN ' . tablename(PDO_NAME . 'fightgroup_userecord') . ' f ON a.id = f.orderid AND a.plugin = \'wlfightgroup\'' . ' LEFT JOIN ' . tablename(PDO_NAME . 'groupon_userecord') . ' g ON a.id = g.orderid AND a.plugin = \'groupon\'' . ' LEFT JOIN ' . tablename(PDO_NAME . 'member_coupons') . ' `c` ON a.orderno = `c`.orderno AND a.plugin = \'coupon\'' . ' LEFT JOIN ' . tablename(PDO_NAME . 'bargain_userlist') . (' b ON a.id = b.orderid AND a.plugin = \'bargain\' ' . $where2));
		$allprice2 = pdo_fetchcolumn('SELECT SUM(actualprice) FROM ' . tablename(PDO_NAME . 'rush_order') . (' ' . $where));
		$allprice = sprintf('%.2f', $allprice1 + $allprice2);
		$limit = ' LIMIT ' . ($pindex - 1) * $psize . ',' . $psize;
		$orderlist = self::getOrderInfo($where, $where2, $limit);

		foreach ($orderlist as $key => &$v) {
			if ($v['a'] == 'a') {
				$ndorder = pdo_get(PDO_NAME . 'order', array('id' => $v['id'], 'uniacid' => $_W['uniacid']), array('id', 'name', 'mobile', 'fightgroupid', 'payfor', 'plugin', 'fkid', 'specid', 'fightstatus', 'expressid', 'recordid', 'goodsprice', 'card_fee', 'remark', 'buyremark'));

				if (empty($v['paytype'])) {
					$paylog = pdo_get('core_paylog', array('tid' => $v['orderno']), array('type'));
					$paytypearray = array('credit' => 1, 'wechat' => 2, 'alipay' => 3, 'delivery' => 4, 'wxapp' => 5);
					$paytype = $paytypearray[$paylog['type']];
					$v['paytype'] = $paytype;
					pdo_update('wlmerchant_order', array('paytype' => $paytype), array('id' => $v['id']));
				}

				if ($ndorder['plugin'] == 'coupon') {
					$goods = wlCoupon::getSingleCoupons($ndorder['fkid'], 'title,logo,id,isdistri');
					$v['goodsname'] = $goods['title'];
					$v['isdistri'] = $goods['isdistri'];
					$v['unit'] = 'å¼ ';
					$v['goodsimg'] = tomedia($goods['logo']);
					$v['actualprice'] = $v['price'];
					$v['price'] = $ndorder['goodsprice'];
					$v['goodsprice'] = sprintf('%.2f', $ndorder['goodsprice'] / $v['num']);
					$v['plugintext'] = 'å¡å¸';
					$v['plugincss'] = 'danger';
					$v['detailurl'] = web_url('order/wlOrder/orderdetail', array('orderid' => $v['id'], 'type' => 3));
				}
				else if ($ndorder['plugin'] == 'wlfightgroup') {
					$goods = Wlfightgroup::getSingleGood($ndorder['fkid'], 'name,logo,id,unit,vipdiscount,isdistri');
					$group = pdo_get('wlmerchant_fightgroup_group', array('id' => $ndorder['fightgroupid']));

					if ($group['status'] == 1) {
						$v['status'] = 10;
					}

					$v['goodsname'] = $goods['name'];
					$v['isdistri'] = $goods['isdistri'];
					$v['unit'] = $goods['unit'];
					$v['goodsimg'] = tomedia($goods['logo']);
					$v['actualprice'] = $v['price'];
					$v['price'] = $ndorder['goodsprice'];
					$v['goodsprice'] = sprintf('%.2f', $ndorder['goodsprice'] / $v['num']);
					$v['plugintext'] = 'æ¼å¢';
					$v['plugincss'] = 'warning';
					$v['detailurl'] = web_url('order/wlOrder/orderdetail', array('orderid' => $v['id'], 'type' => 2));

					if ($ndorder['specid']) {
						$v['optiontitle'] = pdo_getcolumn(PDO_NAME . 'goods_option', array('id' => $ndorder['specid']), 'title');
					}

					if ($v['vipbuyflag']) {
						$v['vipdiscount'] = sprintf('%.2f', $goods['vipdiscount'] * $v['num']);
					}

					$v['dkmoney'] = sprintf('%.2f', $ndorder['card_fee'] - $v['vipdiscount']);
				}
				else if ($ndorder['plugin'] == 'groupon') {
					$goods = pdo_get('wlmerchant_groupon_activity', array('id' => $ndorder['fkid']), array('name', 'isdistri', 'thumb', 'id', 'unit'));
					$v['goodsname'] = $goods['name'];
					$v['isdistri'] = $goods['isdistri'];
					$v['unit'] = $goods['unit'];
					$v['goodsimg'] = tomedia($goods['thumb']);
					$v['actualprice'] = $v['price'];
					$v['price'] = $ndorder['goodsprice'];
					$v['goodsprice'] = sprintf('%.2f', $ndorder['goodsprice'] / $v['num']);
					$v['plugintext'] = 'å¢è´­';
					$v['plugincss'] = 'info';
					$v['detailurl'] = web_url('order/wlOrder/orderdetail', array('orderid' => $v['id'], 'type' => 10));

					if ($ndorder['specid']) {
						$v['optiontitle'] = pdo_getcolumn(PDO_NAME . 'goods_option', array('id' => $ndorder['specid']), 'title');
					}
				}
				else {
					if ($ndorder['plugin'] == 'bargain') {
						$goods = pdo_get('wlmerchant_bargain_activity', array('id' => $ndorder['fkid']), array('name', 'isdistri', 'thumb', 'id', 'unit'));
						$v['goodsname'] = $goods['name'];
						$v['isdistri'] = $goods['isdistri'];
						$v['unit'] = $goods['unit'];
						$v['goodsimg'] = tomedia($goods['thumb']);
						$v['actualprice'] = $v['price'];
						$v['price'] = $ndorder['goodsprice'];
						$v['goodsprice'] = sprintf('%.2f', $ndorder['goodsprice'] / $v['num']);
						$v['plugintext'] = 'ç ä»·';
						$v['plugincss'] = 'primary';
						$v['detailurl'] = web_url('order/wlOrder/orderdetail', array('orderid' => $v['id'], 'type' => 12));
					}
				}

				$v['expressid'] = $ndorder['expressid'];
				$v['remark'] = $ndorder['remark'];
				$v['buyremark'] = $ndorder['buyremark'];
				$v['username'] = $ndorder['name'];
				$v['mobile'] = $ndorder['mobile'];
				$v['goodsid'] = $ndorder['fkid'];
			}
			else {
				$rushorder = pdo_get(PDO_NAME . 'rush_order', array('id' => $v['id'], 'uniacid' => $_W['uniacid']), array('activityid', 'username', 'mobile', 'optionid', 'dkmoney', 'actualprice', 'remark', 'adminremark', 'expressid'));

				if (empty($v['paytype'])) {
					$paylog = pdo_get('core_paylog', array('tid' => $v['orderno']), array('type'));
					$paytypearray = array('credit' => 1, 'wechat' => 2, 'alipay' => 3, 'delivery' => 4, 'wxapp' => 5);
					$paytype = $paytypearray[$paylog['type']];
					$v['paytype'] = $paytype;
					pdo_update('wlmerchant_rush_order', array('paytype' => $paytype), array('id' => $v['id']));
				}

				$v['activityid'] = pdo_getcolumn(PDO_NAME . 'rush_order', array('id' => $v['id'], 'uniacid' => $_W['uniacid']), 'activityid');
				$goods = Rush::getSingleActive($v['activityid'], 'name,thumb,id,isdistri,cutofftime,unit');
				$v['unit'] = $goods['unit'];
				$v['isdistri'] = $goods['isdistri'];
				$v['mobile'] = $goods['mobile'];
				$v['goodsimg'] = tomedia($goods['thumb']);
				$v['goodsname'] = $goods['name'];

				if ($rushorder['expressid']) {
					$expressprice = pdo_getcolumn(PDO_NAME . 'express', array('id' => $rushorder['expressid']), 'expressprice');
					$rushprice = $v['price'] - $expressprice;
				}
				else {
					$rushprice = $v['price'];
				}

				$v['goodsprice'] = sprintf('%.2f', $rushprice / $v['num']);
				$v['actualprice'] = $rushorder['actualprice'];
				$v['plugin'] = 'rush';
				$v['plugintext'] = 'æ¢è´­';
				$v['plugincss'] = 'success';
				$v['detailurl'] = web_url('order/wlOrder/orderdetail', array('orderid' => $v['id'], 'type' => 1));

				if ($rushorder['optionid']) {
					$v['optiontitle'] = pdo_getcolumn(PDO_NAME . 'goods_option', array('id' => $rushorder['optionid']), 'title');
				}

				$v['remark'] = $rushorder['adminremark'];
				$v['buyremark'] = $rushorder['remark'];
				$v['expressid'] = $rushorder['expressid'];
				$v['dkmoney'] = $rushorder['dkmoney'];
				$v['username'] = $rushorder['username'];
				$v['mobile'] = $rushorder['mobile'];
				$v['goodsid'] = $rushorder['activityid'];
			}

			$v['merchantName'] = pdo_getcolumn(PDO_NAME . 'merchantdata', array('id' => $v['sid'], 'uniacid' => $_W['uniacid']), 'storename');
			$member = pdo_get(PDO_NAME . 'member', array('id' => $v['mid']), array('nickname', 'avatar', 'mobile', 'realname'));

			if (!empty($v['username'])) {
				$member['realname'] = $v['username'];
			}

			if (!empty($v['mobile'])) {
				$member['mobile'] = $v['mobile'];
			}

			$v['member'] = $member;

			if ($v['expressid']) {
				$v['express'] = pdo_get(PDO_NAME . 'express', array('id' => $v['expressid']), array('id', 'expressprice', 'expressname', 'expresssn'));
			}

			if ($v['disorderid']) {
				$v['merchname'] = pdo_getcolumn(PDO_NAME . 'merchantdata', array('id' => $v['sid']), 'storename');
				$disorder = pdo_get('wlmerchant_disorder', array('id' => $v['disorderid']));
				$v['disorderstatus'] = $disorder['status'];
				$leadmoney = unserialize($disorder['leadmoney']);

				if ($disorder['twoleadid']) {
					$v['level'] = '2';
				}
				else {
					$v['level'] = '1';
				}

				$v['onecommission'] = $leadmoney['one'];
				$onecom = pdo_get(PDO_NAME . 'distributor', array('id' => $disorder['oneleadid']), array('nickname', 'mid'));
				$v['onecomname'] = $onecom['nickname'];
				$v['onecommid'] = $onecom['mid'];
				$v['twocommission'] = $leadmoney['two'];
				$twocom = pdo_get(PDO_NAME . 'distributor', array('id' => $disorder['twoleadid']), array('nickname', 'mid'));
				$v['twocomname'] = $twocom['nickname'];
				$v['twocommid'] = $twocom['mid'];
				$v['commission'] = sprintf('%.2f', $v['onecommission'] + $v['twocommission']);
			}

			switch ($v['status']) {
			case '0':
				$v['statuscss'] = 'defualt';
				$v['statustext'] = 'æªæ¯ä»';
				break;

			case '1':
				$v['statuscss'] = 'info';
				$v['statustext'] = 'å·²æ¯ä»';
				break;

			case '2':
				$v['statuscss'] = 'success';
				$v['statustext'] = 'å¾è¯ä»·';
				break;

			case '3':
				$v['statuscss'] = 'success';
				$v['statustext'] = 'å·²å®æ';
				break;

			case '4':
				$v['statuscss'] = 'success';
				$v['statustext'] = 'å¾æ¶è´§';
				break;

			case '5':
				$v['statuscss'] = 'defualt';
				$v['statustext'] = 'å·²åæ¶';
				break;

			case '6':
				$v['statuscss'] = 'warning';
				$v['statustext'] = 'å¾éæ¬¾';
				break;

			case '7':
				$v['statuscss'] = 'defualt';
				$v['statustext'] = 'å·²éæ¬¾';
				break;

			case '8':
				$v['statuscss'] = 'info';
				$v['statustext'] = 'å¾åè´§';
				break;

			case '9':
				$v['statuscss'] = 'danger';
				$v['statustext'] = 'å·²è¿æ';
				break;

			case '10':
				$v['statuscss'] = 'info';
				$v['statustext'] = 'ç»å¢ä¸­';
				break;

			default:
				$v['statuscss'] = 'danger';
				$v['statustext'] = 'éè¯¯ç¶æ';
				break;
			}
		}

		$pager = pagination($total, $pindex, $psize);
		include wl_template('order/orderlist');
	}

	public function export($where, $where2)
	{
		global $_W;
		global $_GPC;
		$limit = ' LIMIT 20000';
		$orderlist = self::getOrderInfo($where, $where2, $limit);

		foreach ($orderlist as $key => &$va) {
			if ($va['a'] == 'a') {
				$ndorder = pdo_get(PDO_NAME . 'order', array('id' => $va['id'], 'uniacid' => $_W['uniacid']), array('id', 'payfor', 'plugin', 'mobile', 'fkid', 'fightstatus', 'neworderflag', 'expressid', 'recordid', 'goodsprice', 'card_fee', 'remark', 'buyremark', 'specid'));

				if ($ndorder['plugin'] == 'wlfightgroup') {
					$va['plugin'] = 'æ¼å¢';
					$va['gname'] = pdo_getcolumn(PDO_NAME . 'fightgroup_goods', array('id' => $ndorder['fkid']), 'name');

					if ($ndorder['specid']) {
						$va['option'] = pdo_getcolumn(PDO_NAME . 'goods_option', array('id' => $ndorder['specid']), 'title');
					}

					if ($ndorder['recordid']) {
						$va['usedtime'] = pdo_getcolumn(PDO_NAME . 'fightgroup_userecord', array('id' => $ndorder['recordid']), 'usedtime');
						$va['checkcode'] = pdo_getcolumn(PDO_NAME . 'fightgroup_userecord', array('id' => $ndorder['recordid']), 'qrcode');
					}
				}
				else if ($ndorder['plugin'] == 'groupon') {
					$va['plugin'] = 'å¢è´­';
					$va['gname'] = pdo_getcolumn(PDO_NAME . 'groupon_activity', array('id' => $ndorder['fkid']), 'name');

					if ($ndorder['specid']) {
						$va['option'] = pdo_getcolumn(PDO_NAME . 'goods_option', array('id' => $ndorder['specid']), 'title');
					}

					if ($ndorder['recordid']) {
						$va['usedtime'] = pdo_getcolumn(PDO_NAME . 'groupon_userecord', array('id' => $ndorder['recordid']), 'usedtime');
						$va['checkcode'] = pdo_getcolumn(PDO_NAME . 'groupon_userecord', array('id' => $ndorder['recordid']), 'qrcode');
					}
				}
				else if ($ndorder['plugin'] == 'coupon') {
					$va['plugin'] = 'å¡å¸';
					$va['gname'] = pdo_getcolumn(PDO_NAME . 'couponlist', array('id' => $ndorder['fkid']), 'title');

					if ($ndorder['recordid']) {
						$va['usedtime'] = pdo_getcolumn(PDO_NAME . 'member_coupons', array('id' => $ndorder['recordid']), 'usedtime');
						$va['checkcode'] = pdo_getcolumn(PDO_NAME . 'member_coupons', array('id' => $ndorder['recordid']), 'concode');
					}
				}
				else {
					if ($ndorder['plugin'] == 'bargain') {
						$va['plugin'] = 'ç ä»·';
						$va['gname'] = pdo_getcolumn(PDO_NAME . 'bargain_activity', array('id' => $ndorder['fkid']), 'name');
						$va['usedtime'] = pdo_getcolumn(PDO_NAME . 'bargain_userlist', array('id' => $ndorder['specid']), 'usedtime');
						$va['checkcode'] = pdo_getcolumn(PDO_NAME . 'bargain_userlist', array('id' => $ndorder['specid']), 'qrcode');
					}
				}

				$va['remark'] = $ndorder['buyremark'];
				$va['expressid'] = $ndorder['expressid'];
				$va['mobile'] = $ndorder['mobile'];
				$va['remark'] = $ndorder['remark'];
				$va['buyremark'] = $ndorder['buyremark'];
				$va['small'] = pdo_getall('wlmerchant_smallorder', array('orderid' => $ndorder['id'], 'plugin' => $ndorder['plugin']), '', '', 'status ASC,hexiaotime ASC');
				$va['neworderflag'] = $ndorder['neworderflag'];
			}
			else {
				$rushorder = pdo_get(PDO_NAME . 'rush_order', array('id' => $va['id'], 'uniacid' => $_W['uniacid']), array('actualprice', 'neworderflag', 'remark', 'adminremark', 'usedtime', 'optionid', 'checkcode', 'adminremark', 'activityid', 'mobile', 'address', 'username'));
				$va['plugin'] = 'æ¢è´­';
				$va['gname'] = pdo_getcolumn(PDO_NAME . 'rush_activity', array('id' => $rushorder['activityid']), 'name');
				$va['usedtime'] = $rushorder['usedtime'];
				$va['checkcode'] = $rushorder['checkcode'];

				if ($rushorder['optionid']) {
					$va['option'] = pdo_getcolumn(PDO_NAME . 'goods_option', array('id' => $rushorder['optionid']), 'title');
				}

				$va['peoplename'] = $rushorder['username'];
				$va['tel'] = $rushorder['mobile'];
				$va['address'] = $rushorder['address'];
				$va['mobile'] = $rushorder['mobile'];
				$va['remark'] = $rushorder['adminremark'];
				$va['buyremark'] = $rushorder['remark'];
				$va['small'] = pdo_getall('wlmerchant_smallorder', array('orderid' => $va['id'], 'plugin' => 'rush'), '', '', 'status ASC,hexiaotime ASC');
				$va['neworderflag'] = $rushorder['neworderflag'];
			}

			$va['merchantName'] = pdo_getcolumn(PDO_NAME . 'merchantdata', array('id' => $va['sid']), 'storename');
			$va['salesmid'] = pdo_getcolumn(PDO_NAME . 'merchantdata', array('id' => $va['sid']), 'salesmid');
			$member = pdo_get('wlmerchant_member', array('id' => $va['mid']), array('nickname', 'mobile'));
			$va['nickname'] = $member['nickname'];

			if (empty($va['mobile'])) {
				$va['mobile'] = $member['mobile'];
			}

			if ($va['expressid']) {
				$express = pdo_get('wlmerchant_express', array('id' => $va['expressid']), array('name', 'tel', 'address', 'expressname', 'expresssn'));
				$va['peoplename'] = $express['name'];
				$va['tel'] = $express['tel'];
				$va['address'] = $express['address'];
				$va['expressname'] = $express['expressname'];
				$va['expresssn'] = $express['expresssn'];
			}

			if ($va['disorderid']) {
				$disorder = pdo_get('wlmerchant_disorder', array('id' => $va['disorderid']));
				$leadmoney = unserialize($disorder['leadmoney']);
				$va['onecommission'] = $leadmoney['one'];
				$onecom = pdo_get(PDO_NAME . 'distributor', array('id' => $disorder['oneleadid']), array('nickname', 'mid'));
				$va['onecomname'] = $onecom['nickname'];
				$va['onecommid'] = $onecom['mid'];
				$va['twocommission'] = $leadmoney['two'];
				$twocom = pdo_get(PDO_NAME . 'distributor', array('id' => $disorder['twoleadid']), array('nickname', 'mid'));
				$va['twocomname'] = $twocom['nickname'];
				$va['twocommid'] = $twocom['mid'];
				$va['commission'] = sprintf('%.2f', $va['onecommission'] + $va['twocommission']);
			}

			$va['orderno'] = $va['orderno'] . '	';
		}

		$filter = array('id' => 'è®¢åid', 'orderno' => 'è®¢åå·', 'plugin' => 'æå±åºç¨', 'gname' => 'åååç§°', 'option' => 'è§æ ¼åç§°', 'num' => 'æ°é', 'merchantName' => 'æå±åå®¶', 'nickname' => 'ä¹°å®¶æµç§°', 'mobile' => 'ä¹°å®¶çµè¯', 'status' => 'è®¢åç¶æ', 'paytype' => 'æ¯ä»æ¹å¼', 'createtime' => 'ä¸åæ¶é´', 'paytime' => 'æ¯ä»æ¶é´', 'price' => 'å®ä»éé¢', 'buyremark' => 'ä¹°å®¶å¤æ³¨', 'remark' => 'åå®¶å¤æ³¨', 'peoplename' => 'æ¶è´§äººå§å', 'tel' => 'æ¶è´§äººçµè¯', 'address' => 'æ¶è´§äººå°å', 'expressname' => 'ç©æµå¬å¸', 'expresssn' => 'å¿«éåå·', 'checkcode' => 'æ ¸éç ', 'hexiaotime' => 'æ ¸éæ¶é´', 'vermember' => 'æ ¸éå', 'salesmid' => 'ä¸å¡å', 'commission' => 'åéæ»ä½£é', 'onecommission' => 'ä¸çº§åéä½£é', 'onecommid' => 'ä¸çº§åéåMID', 'onecomname' => 'ä¸çº§åéåæµç§°', 'twocommission' => 'äºçº§åéä½£é', 'twocommid' => 'äºçº§åéåMID', 'twocomname' => 'äºçº§åéåæµç§°');
		$data = array();
		$i = 0;

		while ($i < count($orderlist)) {
			foreach ($filter as $key => $title) {
				$data[$i][$key] = $orderlist[$i]['id'];
				if ($key == 'createtime' || $key == 'paytime') {
					$data[$i][$key] = date('Y-m-d H:i:s', $orderlist[$i][$key]);
				}
				else if ($key == 'status') {
					switch ($orderlist[$i][$key]) {
					case '1':
						$data[$i][$key] = 'å·²æ¯ä»';
						break;

					case '2':
						$data[$i][$key] = 'å·²æ¶è´¹';
						break;

					case '3':
						$data[$i][$key] = 'å·²å®æ';
						break;

					case '4':
						$data[$i][$key] = 'å¾ä½¿ç¨';
						break;

					case '5':
						$data[$i][$key] = 'å·²åæ¶';
						break;

					case '6':
						$data[$i][$key] = 'å¾éæ¬¾';
						break;

					case '7':
						$data[$i][$key] = 'å·²éæ¬¾';
						break;

					case '8':
						$data[$i][$key] = 'å¾æ¶è´§';
						break;

					case '9':
						$data[$i][$key] = 'å·²è¿æ';
						break;

					default:
						$data[$i][$key] = 'æªæ¯ä»';
						break;
					}
				}
				else if ($key == 'paytype') {
					switch ($orderlist[$i][$key]) {
					case '1':
						$data[$i][$key] = 'ä½é¢æ¯ä»';
						break;

					case '2':
						$data[$i][$key] = 'å¾®ä¿¡æ¯ä»';
						break;

					case '3':
						$data[$i][$key] = 'æ¯ä»å®æ¯ä»';
						break;

					case '4':
						$data[$i][$key] = 'è´§å°ä»æ¬¾';
						break;

					default:
						$data[$i][$key] = 'å¶ä»ææªæ¯ä»';
						break;
					}
				}
				else if ($key == 'checkcode') {
					if ($orderlist[$i]['neworderflag']) {
						$checkcode = '';

						foreach ($orderlist[$i]['small'] as $kchcek => $sm) {
							if ($kchcek != 0) {
								$checkcode .= '||' . $sm['checkcode'];
							}
							else {
								$checkcode .= $sm['checkcode'];
							}
						}

						$data[$i][$key] = $checkcode;
					}
					else {
						$data[$i][$key] = $orderlist[$i][$key];
					}
				}
				else if ($key == 'hexiaotime') {
					$usedrecord = '';

					if ($orderlist[$i]['neworderflag']) {
						foreach ($orderlist[$i]['small'] as $ktime => $sm) {
							if ($ktime != 0) {
								if ($sm['status'] == 1) {
									$usedrecord .= ' || æªæ ¸é';
								}
								else if ($sm['status'] == 2) {
									$usedrecord .= ' || ' . date('Y-m-d H:i:s', $sm['hexiaotime']);
								}
								else {
									if ($sm['status'] == 3) {
										$usedrecord .= ' || ' . date('Y-m-d H:i:s', $sm['refundtime']);
									}
								}
							}
							else if ($sm['status'] == 1) {
								$usedrecord .= 'æªæ ¸é';
							}
							else if ($sm['status'] == 2) {
								$usedrecord .= date('Y-m-d H:i:s', $sm['hexiaotime']);
							}
							else {
								if ($sm['status'] == 3) {
									$usedrecord .= date('Y-m-d H:i:s', $sm['refundtime']);
								}
							}
						}
					}
					else {
						$usedtime = unserialize($orderlist[$i]['usedtime']);

						if ($usedtime) {
							foreach ($usedtime as $kK => $used) {
								if ($kK != 0) {
									$usedrecord .= ' || ' . date('Y-m-d H:i:s', $used['time']);
								}
								else {
									$usedrecord .= date('Y-m-d H:i:s', $used['time']);
								}
							}
						}
					}

					$data[$i][$key] = $usedrecord;
				}
				else if ($key == 'vermember') {
					$vermembers = '';

					if ($orderlist[$i]['neworderflag']) {
						foreach ($orderlist[$i]['small'] as $kuid => $sm) {
							if ($sm['status'] == 1) {
								$verm = 'æªæ ¸é';
							}
							else if ($sm['status'] == 2) {
								$verm = pdo_getcolumn(PDO_NAME . 'merchantuser', array('id' => $sm['hxuid']), 'name');
							}
							else {
								if ($sm['status'] == 3) {
									$verm = 'å·²éæ¬¾';
								}
							}

							if ($kuid != 0) {
								$vermembers .= ' || ' . $verm;
							}
							else {
								$vermembers .= $verm;
							}
						}
					}
					else {
						$usedtime = unserialize($orderlist[$i]['usedtime']);

						if ($usedtime) {
							foreach ($usedtime as $kKs => $user2) {
								$user2['vername'] = pdo_getcolumn(PDO_NAME . 'merchantuser', array('mid' => $user2['ver']), 'name');

								if ($user2['type'] == 3) {
									$user2['vername'] = 'åå°æ ¸é';
								}
								else {
									if ($user2['type'] == 4) {
										$user2['vername'] = 'å¯ç æ ¸é';
									}
								}

								if ($kKs != 0) {
									$vermembers .= ' || ' . $user2['vername'];
								}
								else {
									$vermembers .= $user2['vername'];
								}
							}
						}
					}

					$data[$i][$key] = $vermembers;
				}
				else {
					$data[$i][$key] = $orderlist[$i][$key];
				}
			}

			++$i;
		}

		util_csv::export_csv_2($data, $filter, 'è®¢åè¡¨.csv');
		exit();
	}

	public function orderdetail()
	{
		global $_W;
		global $_GPC;
		$currentid = $_GPC['currentid'];
		$orderid = $_GPC['orderid'];
		$type = $_GPC['type'];

		if ($currentid) {
			$current = pdo_get('wlmerchant_current', array('id' => $currentid), array('type', 'orderid'));
			$type = $current['type'];
			$orderid = $current['orderid'];
		}

		if ($type == 1) {
			$order = pdo_get('wlmerchant_rush_order', array('id' => $orderid));
			$order['remark'] = $order['adminremark'];
			$goodsprice = $order['price'];
			$order['ordera'] = 'b';

			if ($order['optionid']) {
				$order['optiontitle'] = pdo_getcolumn(PDO_NAME . 'goods_option', array('id' => $order['optionid']), 'title');
			}
		}
		else if ($type == 4) {
			$order = pdo_get('wlmerchant_halfcard_record', array('id' => $orderid));
			$goodsprice = $order['price'];
		}
		else {
			$order = pdo_get('wlmerchant_order', array('id' => $orderid));
			$goodsprice = $order['goodsprice'];
			$order['ordera'] = 'a';
			if ($order['specid'] && $type != 12 && $type != 8) {
				$order['optiontitle'] = pdo_getcolumn(PDO_NAME . 'goods_option', array('id' => $order['specid']), 'title');
			}

			$order['username'] = $order['name'];

			if ($order['recordid']) {
				if ($order['plugin'] == 'groupon') {
					$order['checkcode'] = pdo_getcolumn(PDO_NAME . 'groupon_userecord', array('id' => $order['recordid']), 'qrcode');
				}
				else if ($order['plugin'] == 'wlfightgroup') {
					$order['checkcode'] = pdo_getcolumn(PDO_NAME . 'fightgroup_userecord', array('id' => $order['recordid']), 'qrcode');
				}
				else {
					if ($order['plugin'] == 'bargain') {
						$order['checkcode'] = pdo_getcolumn(PDO_NAME . 'bargain_userlist', array('id' => $order['recordid']), 'qrcode');
					}
				}
			}
		}

		if ($order['transid']) {
			$order['wqorderno'] = pdo_getcolumn('core_paylog', array('uniacid' => $_W['uniacid'], 'tid' => $order['orderno']), 'uniontid');
		}

		switch ($type) {
		case '1':
			$plugin = 'rush';
			break;

		case '2':
			$plugin = 'wlfightgroup';
			break;

		case '3':
			$plugin = 'coupon';
			break;

		case '9':
			$plugin = 'activity';
			break;

		case '10':
			$plugin = 'groupon';
			break;

		case '11':
			$plugin = 'halfcard';
			break;

		case '12':
			$plugin = 'bargain';
			break;
		}

		$member = pdo_get('wlmerchant_member', array('id' => $order['mid']), array('nickname', 'mobile', 'avatar', 'realname', 'id'));
		$order['avatar'] = $member['avatar'];

		switch ($order['status']) {
		case '0':
			$order['statuscss'] = 'default';
			$order['statustext'] = 'æªæ¯ä»';
			break;

		case '1':
			$order['statuscss'] = 'info';
			$order['statustext'] = 'å·²æ¯ä»';
			break;

		case '2':
			$order['statuscss'] = 'success';
			$order['statustext'] = 'å¾è¯ä»·';
			break;

		case '3':
			$order['statuscss'] = 'success';
			$order['statustext'] = 'å·²å®æ';
			break;

		case '4':
			$order['statuscss'] = 'success';
			$order['statustext'] = 'å¾æ¶è´§';
			break;

		case '5':
			$order['statuscss'] = 'defualt';
			$order['statustext'] = 'å·²åæ¶';
			break;

		case '6':
			$order['statuscss'] = 'warning';
			$order['statustext'] = 'å¾éæ¬¾';
			break;

		case '7':
			$order['statuscss'] = 'defualt';
			$order['statustext'] = 'å·²éæ¬¾';
			break;

		case '8':
			$order['statuscss'] = 'info';
			$order['statustext'] = 'å¾åè´§';
			break;

		case '9':
			$order['statuscss'] = 'danger';
			$order['statustext'] = 'å·²è¿æ';
			break;

		default:
			$order['statuscss'] = 'danger';
			$order['statustext'] = 'éè¯¯ç¶æ';
			break;
		}

		switch ($order['paytype']) {
		case '1':
			$order['paytypecss'] = 'info';
			$order['paytypetext'] = 'ä½é¢æ¯ä»';
			break;

		case '2':
			$order['paytypecss'] = 'success';
			$order['paytypetext'] = 'å¾®ä¿¡æ¯ä»';
			break;

		case '3':
			$order['paytypecss'] = 'danger';
			$order['paytypetext'] = 'æ¯ä»å®';
			break;

		case '4':
			$order['paytypecss'] = 'warning';
			$order['paytypetext'] = 'è´§å°ä»æ¬¾';
			break;

		case '5':
			$order['paytypecss'] = 'warning';
			$order['paytypetext'] = 'å°ç¨åºæ¯ä»';
			break;

		default:
			$order['paytypecss'] = 'default';
			$order['paytypetext'] = 'æªç¥æ¹å¼';
			break;
		}

		$logs = array();
		$logs[] = array('time' => $order['createtime'], 'title' => 'è®¢åæäº¤æå', 'detail' => 'åå·:' . $order['orderno'] . 'ï¼ç­å¾ä¹°å®¶ä»æ¬¾');

		if ($type == 1) {
			$usedtime = unserialize($order['usedtime']);

			if ($order['paytime']) {
				$logs[] = array('time' => $order['paytime'], 'title' => 'è®¢åæ¯ä»æå', 'detail' => 'æ¯ä»æåï¼ç­å¾ä¹°å®¶åå¾åæ·æ ¸éè®¢åæåå®¶åè´§');
			}

			if ($order['expressid']) {
				$express = pdo_get('wlmerchant_express', array('id' => $order['expressid']), array('expressname', 'expresssn', 'expressprice', 'sendtime', 'receivetime'));
				$expressprice = $express['expressprice'];

				if ($express['sendtime']) {
					$logs[] = array('time' => $express['sendtime'], 'title' => 'ååå·²åè´§', 'detail' => 'å¿«éå¬å¸:' . $express['expressname'] . ',å¿«éåå·:' . $express['expresssn'] . ',ç­å¾ä¹°å®¶æ¶è´§');
				}

				if ($express['receivetime']) {
					$logs[] = array('time' => $express['receivetime'], 'title' => 'ååå·²ç­¾æ¶', 'detail' => 'ç¨æ·å·²ç­¾æ¶ååï¼ç­å¾ç³»ç»ç»ç®è®¢å');
				}
			}
		}

		if ($type == 2) {
			if ($order['fightstatus'] == 1) {
				if ($order['paytime']) {
					$logs[] = array('time' => $order['paytime'], 'title' => 'è®¢åæ¯ä»æå', 'detail' => 'æ¯ä»æåï¼ç­å¾ç»å¢æå');
				}

				$group = pdo_get('wlmerchant_fightgroup_group', array('id' => $order['fightgroupid']));

				if ($group['status'] == 2) {
					$logs[] = array('time' => $group['successtime'], 'title' => 'ç»å¢æå', 'detail' => 'æ¼å¢ç»å¢æåï¼ç­å¾ä¹°å®¶åå¾åæ·æ ¸éè®¢åæåå®¶åè´§');
				}
				else {
					if ($group['status'] == 3) {
						$logs[] = array('time' => $group['failtime'], 'title' => 'ç»å¢å¤±è´¥', 'detail' => 'æ¼å¢ç»å¢å¤±è´¥ï¼å³å°ç»ä¹°å®¶éæ¬¾');
					}
				}
			}
			else {
				if ($order['paytime']) {
					$logs[] = array('time' => $order['paytime'], 'title' => 'è®¢åæ¯ä»æå', 'detail' => 'æ¯ä»æåï¼ç­å¾ä¹°å®¶åå¾åæ·æ ¸éè®¢åæåå®¶åè´§');
				}
			}

			if ($order['recordid']) {
				$record = pdo_get('wlmerchant_fightgroup_userecord', array('id' => $order['recordid']), array('usedtime'));
				$usedtime = unserialize($record['usedtime']);
			}
			else {
				if ($order['expressid']) {
					$express = pdo_get('wlmerchant_express', array('id' => $order['expressid']), array('expressname', 'expresssn', 'expressprice', 'sendtime', 'receivetime'));
					$expressprice = $express['expressprice'];

					if ($express['sendtime']) {
						$logs[] = array('time' => $express['sendtime'], 'title' => 'ååå·²åè´§', 'detail' => 'å¿«éå¬å¸:' . $express['expressname'] . ',å¿«éåå·:' . $express['expresssn'] . ',ç­å¾ä¹°å®¶æ¶è´§');
					}

					if ($express['receivetime']) {
						$logs[] = array('time' => $express['receivetime'], 'title' => 'ååå·²ç­¾æ¶', 'detail' => 'ç¨æ·å·²ç­¾æ¶ååï¼ç­å¾ç³»ç»ç»ç®è®¢å');
					}
				}
			}
		}

		if ($type == 3) {
			if ($order['paytime']) {
				$logs[] = array('time' => $order['paytime'], 'title' => 'è®¢åæ¯ä»æå', 'detail' => 'æ¯ä»æåï¼ç­å¾ä¹°å®¶åå¾åæ·æ ¸éè®¢å');
			}

			$usedtime = pdo_getcolumn(PDO_NAME . 'member_coupons', array('id' => $order['recordid']), 'usedtime');
			$usedtime = unserialize($usedtime);
		}

		if ($type == 4) {
			if ($order['paytime']) {
				$logs[] = array('time' => $order['paytime'], 'title' => 'è®¢åæ¯ä»æå', 'detail' => 'æ¯ä»æåï¼ä¹°å®¶å·²æåå¼éä¼åï¼ç­å¾ç³»ç»ç»ç®');
			}
		}

		if ($type == 5) {
			if ($order['paytime']) {
				$logs[] = array('time' => $order['paytime'], 'title' => 'è®¢åæ¯ä»æå', 'detail' => 'æ¯ä»æåï¼å¸å­å·²åå¸ï¼ç­å¾ç³»ç»ç»ç®');
			}
		}

		if ($type == 6) {
			if ($order['paytime']) {
				$logs[] = array('time' => $order['paytime'], 'title' => 'è®¢åæ¯ä»æå', 'detail' => 'æ¯ä»æåï¼åå®¶å·²å¥ä½ï¼ç­å¾å®¡æ ¸ï¼è®¢åç­å¾ç³»ç»ç»ç®');
			}
		}

		if ($type == 8) {
			if ($order['paytime']) {
				$logs[] = array('time' => $order['paytime'], 'title' => 'è®¢åæ¯ä»æå', 'detail' => 'æ¯ä»æåï¼åéåç³è¯·æåï¼ç­å¾å®¡æ ¸ï¼è®¢åç­å¾ç³»ç»ç»ç®');
			}
		}

		if ($type == 10) {
			if ($order['paytime']) {
				$logs[] = array('time' => $order['paytime'], 'title' => 'è®¢åæ¯ä»æå', 'detail' => 'æ¯ä»æåï¼ç­å¾ä¹°å®¶åå¾åæ·æ ¸éè®¢å');
			}

			if ($order['expressid']) {
				$express = pdo_get('wlmerchant_express', array('id' => $order['expressid']), array('expressname', 'expresssn', 'expressprice', 'sendtime', 'receivetime'));
				$expressprice = $express['expressprice'];

				if ($express['sendtime']) {
					$logs[] = array('time' => $express['sendtime'], 'title' => 'ååå·²åè´§', 'detail' => 'å¿«éå¬å¸:' . $express['expressname'] . ',å¿«éåå·:' . $express['expresssn'] . ',ç­å¾ä¹°å®¶æ¶è´§');
				}

				if ($express['receivetime']) {
					$logs[] = array('time' => $express['receivetime'], 'title' => 'ååå·²ç­¾æ¶', 'detail' => 'ç¨æ·å·²ç­¾æ¶ååï¼ç­å¾ç³»ç»ç»ç®è®¢å');
				}
			}
			else {
				$usedtime = pdo_getcolumn(PDO_NAME . 'groupon_userecord', array('id' => $order['recordid']), 'usedtime');
				$usedtime = unserialize($usedtime);
			}
		}

		if ($type == 11) {
			if ($order['paytime']) {
				$logs[] = array('time' => $order['paytime'], 'title' => 'è®¢åæ¯ä»æå', 'detail' => 'å¨çº¿ä¹°åæ¯ä»æåï¼è®¢åç­å¾ç³»ç»ç»ç®');
			}
		}

		if ($type == 12) {
			if ($order['expressid']) {
				if ($order['paytime']) {
					$logs[] = array('time' => $order['paytime'], 'title' => 'è®¢åæ¯ä»æå', 'detail' => 'è®¢åæ¯ä»æå,ç­å¾åå®¶åè´§');
				}

				$express = pdo_get('wlmerchant_express', array('id' => $order['expressid']), array('expressname', 'expresssn', 'expressprice', 'sendtime', 'receivetime'));
				$expressprice = $express['expressprice'];

				if ($express['sendtime']) {
					$logs[] = array('time' => $express['sendtime'], 'title' => 'ååå·²åè´§', 'detail' => 'å¿«éå¬å¸:' . $express['expressname'] . ',å¿«éåå·:' . $express['expresssn'] . ',ç­å¾ä¹°å®¶æ¶è´§');
				}

				if ($express['receivetime']) {
					$logs[] = array('time' => $express['receivetime'], 'title' => 'ååå·²ç­¾æ¶', 'detail' => 'ç¨æ·å·²ç­¾æ¶ååï¼ç­å¾ç³»ç»ç»ç®è®¢å');
				}
			}
			else {
				if ($order['paytime']) {
					$logs[] = array('time' => $order['paytime'], 'title' => 'è®¢åæ¯ä»æå', 'detail' => 'è®¢åæ¯ä»æå,ç­å¾ä¹°å®¶å°åºæ ¸é');
				}

				$record = pdo_get('wlmerchant_bargain_userlist', array('id' => $order['specid']), array('usedtime'));
				$usedtime = unserialize($record['usedtime']);
			}
		}

		if ($usedtime) {
			foreach ($usedtime as $key => $used) {
				switch ($used['type']) {
				case '1':
					$used['typename'] = 'è¾ç æ ¸é';
					break;

				case '2':
					$used['typename'] = 'æ«ç æ ¸é';
					break;

				case '3':
					$used['typename'] = 'åå°æ ¸é';
					break;

				case '4':
					$used['typename'] = 'å¯ç æ ¸é';
					break;

				default:
					$used['typename'] = 'æªç¥æ¹å¼';
					break;
				}

				if ($used['type'] == 1 || $used['type'] == 2) {
					$used['vername'] = pdo_getcolumn(PDO_NAME . 'merchantuser', array('mid' => $used['ver'], 'storeid' => $order['sid']), 'name');
				}
				else {
					$used['vername'] = 'æ ';
				}

				$kk = $key + 1;
				$logs[] = array('time' => $used['time'], 'title' => 'ç¬¬' . $kk . 'æ¬¡æ ¸é', 'detail' => 'æ ¸éæ¹å¼:' . $used['typename'] . ',æ ¸éå:' . $used['vername'] . 'ã');
				if (empty($order['usetimes']) && $kk == count($usedtime)) {
					$logs[] = array('time' => $used['time'], 'title' => 'æ ¸éå®æ', 'detail' => 'è®¢åå·²å¨é¨æ ¸éï¼ç­å¾ç³»ç»ç»ç®è®¢å');
				}
			}
		}

		if ($order['neworderflag']) {
			$hexiaotype = array(1 => 'è¾ç æ ¸é', 2 => 'æ«ç æ ¸é', 3 => 'åå°æ ¸é', 4 => 'å¯ç æ ¸é');
			$smallorders = pdo_getall('wlmerchant_smallorder', array('orderid' => $order['id'], 'plugin' => $plugin));

			foreach ($smallorders as $key => $small) {
				if ($small['status'] == 2) {
					$smalltype = $small['hexiaotype'];

					if ($small['hxuid']) {
						$vername = pdo_getcolumn(PDO_NAME . 'merchantuser', array('id' => $small['hxuid']), 'name');
					}
					else {
						$vername = 'æ ';
					}

					$logs[] = array('time' => $small['hexiaotime'], 'title' => 'æ ¸éç ï¼' . $small['checkcode'], 'detail' => 'æ ¸éæ¹å¼:' . $hexiaotype[$smalltype] . ',æ ¸éå:' . $vername . 'ã');
				}
				else {
					if ($small['status'] == 3) {
						$logs[] = array('time' => $small['refundtime'], 'title' => 'æ ¸éç [' . $small['checkcode'] . ']å·²éæ¬¾', 'detail' => '');
					}
				}
			}
		}

		if ($order['status'] == 7) {
			$logs[] = array('time' => $order['refundtime'], 'title' => 'è®¢åå·²éæ¬¾', 'detail' => 'è®¢åå·²éæ¬¾ï¼æ­¤è®¢åå·²ç»æ');
		}

		if ($order['status'] == 9) {
			$logs[] = array('time' => $order['overtime'], 'title' => 'è®¢åå·²è¿æ', 'detail' => 'è®¢åå·²è¿æï¼ç­å¾ç³»ç»ç»ç®è®¢å');
		}

		if ($order['issettlement'] == 1) {
			$settlement = pdo_fetch('SELECT * FROM ' . tablename('wlmerchant_autosettlement_record') . ('WHERE orderid = ' . $order['id'] . ' AND type = ' . $type . ' ORDER BY id DESC'));
			$logs[] = array('time' => $settlement['createtime'], 'title' => 'è®¢åå·²ç»ç®', 'detail' => 'è®¢åå·²ç»ç®ï¼æ­¤è®¢åå·²å®æ');
		}

		if ($order['status'] == 3) {
			$commenttime = pdo_getcolumn(PDO_NAME . 'comment', array('plugin' => $plugin, 'idoforder' => $order['id']), 'createtime');

			if ($commenttime) {
				$logs[] = array('time' => $commenttime, 'title' => 'è®¢åå·²è¯ä»·', 'detail' => 'ç¨æ·å°±æ­¤è®¢åå¯¹åæ·åè¡¨äºè¯ä»·');
			}
		}

		if ($type == 1) {
			$goods = pdo_get('wlmerchant_rush_activity', array('id' => $order['activityid']), array('id', 'price', 'aid', 'vipprice', 'name', 'thumb'));

			if ($order['optionid']) {
				$option = pdo_get('wlmerchant_goods_option', array('id' => $order['optionid']), array('price', 'vipprice'));
				$goods['price'] = $option['price'];
				$goods['vipprice'] = $option['vipprice'];
			}

			$dkmoney = $order['dkmoney'];
			$dkcredit = $order['dkcredit'];
			$actualprice = $order['actualprice'];
			$editurl = './agent.php?uniacid=' . $_W['uniacid'] . '&aid=' . $goods['aid'] . '&p=rush&ac=active&do=createactive&id=' . $goods['id'];
		}
		else if ($type == 2) {
			$goods = pdo_get('wlmerchant_fightgroup_goods', array('id' => $order['fkid']), array('id', 'price', 'aid', 'aloneprice', 'vipdiscount', 'name', 'logo'));

			if ($order['vipbuyflag']) {
				$vipdiscount = sprintf('%.2f', $goods['vipdiscount'] * $order['num']);
			}

			$dkmoney = sprintf('%.2f', $order['card_fee'] - $vipdiscount);
			$dkcredit = $order['card_id'];
			$goods['thumb'] = $goods['logo'];
			$actualprice = $order['price'];
			$editurl = './agent.php?uniacid=' . $_W['uniacid'] . '&aid=' . $goods['aid'] . '&p=wlfightgroup&ac=fightgoods&do=creategood&id=' . $goods['id'];
		}
		else if ($type == 3) {
			$goods = pdo_get('wlmerchant_couponlist', array('id' => $order['fkid']), array('id', 'price', 'aid', 'vipprice', 'title', 'logo'));
			$goods['name'] = $goods['title'];
			$goods['thumb'] = $goods['logo'];
			$actualprice = $order['price'];
			$editurl = './agent.php?uniacid=' . $_W['uniacid'] . '&aid=' . $goods['aid'] . '&p=wlcoupon&ac=couponlist&do=editCoupons&id=' . $goods['id'];
		}
		else if ($type == 10) {
			$goods = pdo_get('wlmerchant_groupon_activity', array('id' => $order['fkid']), array('id', 'aid', 'price', 'vipprice', 'name', 'thumb'));
			$actualprice = $order['price'];
			$editurl = './agent.php?uniacid=' . $_W['uniacid'] . '&aid=' . $goods['aid'] . '&p=groupon&ac=active&do=createactive&id=' . $goods['id'];
		}
		else if ($type == 4) {
			$goods = pdo_get('wlmerchant_halfcard_type', array('id' => $order['typeid']), array('id', 'price', 'name', 'logo'));
			$order['num'] = 1;
			$goods['thumb'] = $goods['logo'];
			$actualprice = $order['price'];
			$editurl = web_url('halfcard/halftype/add', array('id' => $goods['id']));
		}
		else if ($type == 5) {
			$informations = pdo_get('wlmerchant_pocket_informations', array('id' => $order['fkid']), array('type'));
			$goods = pdo_get('wlmerchant_pocket_type', array('id' => $informations['type']), array('title', 'price', 'img'));
			$goods['thumb'] = $goods['img'];
			$goods['name'] = 'åå¸' . $goods['title'] . 'ä¿¡æ¯';
			$actualprice = $order['price'];
			$editurl = web_url('pocket/Type/operating', array('eid' => $goods['id']));
		}
		else if ($type == 6) {
			$goods = pdo_get('wlmerchant_chargelist', array('id' => $order['fkid']), array('id', 'price', 'name'));
			$goods['thumb'] = URL_MODULE . 'web/resource/image/store.png';
			$goods['name'] = 'ä»è´¹å¥é©»:' . $goods['name'];
			$actualprice = $order['price'];
			$order['num'] = 1;
			$editurl = web_url('setting/register/add', array('id' => $goods['id']));
		}
		else if ($type == 8) {
			$goods['thumb'] = URL_MODULE . 'web/resource/image/store.png';
			$goods['name'] = 'ä»è´¹ç³è¯·æä¸ºåéå';
			$actualprice = $order['price'];
			$order['num'] = 1;
			$editurl = web_url('distribution/dissysbase/disbaseset');
		}
		else if ($type == 11) {
			$goods['thumb'] = pdo_getcolumn(PDO_NAME . 'merchantdata', array('uniacid' => $_W['uniacid'], 'id' => $order['sid']), 'logo');
			$goods['thumb'] = tomedia($goods['thumb']);
			$actualprice = $order['price'];
			$order['num'] = 1;

			if ($order['fkid']) {
				$goods['name'] = pdo_getcolumn(PDO_NAME . 'halfcardlist', array('uniacid' => $_W['uniacid'], 'id' => $order['fkid']), 'title');
				$editurl = web_url('halfcard/halfcard_web/editHalfcard', array('id' => $order['fkid']));
			}
			else {
				$goods['name'] = 'ä¹°å®¶å¨çº¿ä¹°å';
			}

			$vipdiscount = $order['card_fee'];
		}
		else {
			if ($type == 12) {
				$actualprice = $order['price'];
				$goods = pdo_get(PDO_NAME . 'bargain_activity', array('uniacid' => $_W['uniacid'], 'id' => $order['fkid']), array('id', 'thumb', 'name'));
				$goods['thumb'] = tomedia($goods['thumb']);
				$editurl = './agent.php?uniacid=' . $_W['uniacid'] . '&aid=' . $goods['aid'] . '&p=bargain&ac=bargain_web&do=createbargain&id=' . $goods['id'];
			}
		}

		if ($order['issettlement'] == 1) {
			if ($order['neworderflag']) {
				$merchantmoney = 0;
				$agentmoney = 0;
				$distrimoney = 0;
				$refundmoney = 0;

				foreach ($smallorders as $key => $small) {
					if ($small['status'] == 2) {
						$merchantmoney += $small['settlemoney'];
						$agentmoney += sprintf('%.2f', $small['orderprice'] - $small['settlemoney'] - $small['onedismoney'] - $small['twodismoney']);
						$distrimoney += sprintf('%.2f', $small['onedismoney'] + $small['twodismoney']);
					}
					else {
						if ($small['status'] == 3) {
							$refundmoney += $small['orderprice'];
						}
					}
				}
			}
			else {
				$agentmoney = $settlement['agentmoney'];
				$merchantmoney = $settlement['merchantmoney'];
				$distrimoney = $settlement['distrimoney'];
			}

			if (0 < $distrimoney) {
				$disorder = pdo_get('wlmerchant_disorder', array('id' => $order['disorderid']), array('oneleadid', 'twoleadid', 'leadmoney'));
				$onename = pdo_getcolumn(PDO_NAME . 'distributor', array('id' => $disorder['oneleadid']), 'nickname');
				$twoname = pdo_getcolumn(PDO_NAME . 'distributor', array('id' => $disorder['twoleadid']), 'nickname');
				$leadmoney = unserialize($disorder['leadmoney']);
			}

			if ($order['shareid']) {
				$shares = pdo_get('wlmerchant_sharegift_record', array('id' => $order['shareid']), array('price', 'type', 'mid'));
				$sharemoney = sprintf('%.2f', $shares['price'] * $order['num']);

				if ($shares['type'] == 2) {
					$sharename = pdo_getcolumn(PDO_NAME . 'member', array('id' => $shares['mid']), 'nickname');
				}
			}
		}

		if ($order['status'] == 7 && $order['neworderflag']) {
			$refundmoney = $actualprice;
			$merchantmoney = 0;
		}

		if ($order['expressid']) {
			$express = pdo_get('wlmerchant_express', array('id' => $order['expressid']));
		}

		include wl_template('finace/newcashorder');
	}

	public function payonlinelist()
	{
		global $_W;
		global $_GPC;
		$pindex = max(1, intval($_GPC['page']));
		$psize = 20;
		$store_where = is_agent() ? array('uniacid' => $_W['uniacid'], 'aid' => $_W['aid']) : array('uniacid' => $_W['uniacid']);
		$stores = pdo_getall('wlmerchant_merchantdata', $store_where, array('id', 'storename'));
		$where = array();
		$where['uniacid'] = $_W['uniacid'];
		$where['plugin'] = 'halfcard';
		$where['status>'] = 1;

		if (is_agent()) {
			$where['aid'] = $_W['aid'];
		}

		$sid = intval($_GPC['sid']);

		if ($sid) {
			$where['sid'] = $sid;
		}

		if ($_GPC['paytype']) {
			$where['paytype'] = $_GPC['paytype'];
		}

		if ($_GPC['keyword']) {
			$keyword = $_GPC['keyword'];

			if ($_GPC['keywordtype'] == 1) {
				$params[':name'] = '%' . $keyword . '%';
				$members = pdo_fetchall('SELECT * FROM ' . tablename('wlmerchant_member') . (' WHERE uniacid = ' . $_W['uniacid'] . '  AND nickname LIKE :name'), $params);

				if ($members) {
					$mids = '(';

					foreach ($members as $key => $v) {
						if ($key == 0) {
							$mids .= $v['id'];
						}
						else {
							$mids .= ',' . $v['id'];
						}
					}

					$mids .= ')';
					$where['mid#'] = $mids;
				}
			}
			else {
				if ($_GPC['keywordtype'] == 2) {
					$params[':name'] = '%' . $keyword . '%';
					$members = pdo_fetchall('SELECT * FROM ' . tablename('wlmerchant_member') . (' WHERE uniacid = ' . $_W['uniacid'] . ' AND mobile LIKE :name'), $params);

					if ($members) {
						$mids = '(';

						foreach ($members as $key => $v) {
							if ($key == 0) {
								$mids .= $v['id'];
							}
							else {
								$mids .= ',' . $v['id'];
							}
						}

						$mids .= ')';
						$where['mid#'] = $mids;
					}
				}
			}
		}

		if ($_GPC['time_limit']) {
			$time_limit = $_GPC['time_limit'];
			$starttime = strtotime($_GPC['time_limit']['start']);
			$endtime = strtotime($_GPC['time_limit']['end']);
			$where['paytime>'] = $starttime;
			$where['paytime<'] = $endtime + 86400;
		}

		if (empty($starttime) || empty($endtime)) {
			$starttime = strtotime('-1 month');
			$endtime = time();
		}

		if ($_GPC['export']) {
			$this->exportpayonline($where);
		}

		$payonlinelist = Util::getNumData('*', 'wlmerchant_order', $where, 'paytime DESC', $pindex, $psize, 1);
		$pager = $payonlinelist[1];
		$list = $payonlinelist[0];

		foreach ($list as $key => &$li) {
			$member = pdo_get('wlmerchant_member', array('id' => $li['mid']), array('avatar', 'nickname'));
			$li['avatar'] = tomedia($member['avatar']);
			$li['nickname'] = $member['nickname'];
			$store = pdo_get(PDO_NAME . 'merchantdata', array('uniacid' => $_W['uniacid'], 'id' => $li['sid']), array('logo', 'storename'));
			$li['logo'] = tomedia($store['logo']);

			if ($li['fkid']) {
				$li['title'] = pdo_getcolumn(PDO_NAME . 'halfcardlist', array('uniacid' => $_W['uniacid'], 'id' => $li['fkid']), 'title');
			}
			else {
				$li['title'] = $store['storename'] . 'ä¹°å®¶å¨çº¿ä¹°å';
			}

			$li['paytime'] = date('Y-m-d H:i:s', $li['paytime']);
		}

		include wl_template('order/payonlinelist');
	}

	public function exportpayonline($where)
	{
		global $_W;
		global $_GPC;
		$payonlinelist = Util::getNumData('*', 'wlmerchant_order', $where, 'paytime DESC', $pindex, $psize, 1);
		$pager = $payonlinelist[1];
		$list = $payonlinelist[0];

		foreach ($list as $key => &$li) {
			$member = pdo_get('wlmerchant_member', array('id' => $li['mid']), array('mobile', 'nickname'));
			$li['mobile'] = $member['mobile'];
			$li['nickname'] = $member['nickname'];
			$store = pdo_get(PDO_NAME . 'merchantdata', array('uniacid' => $_W['uniacid'], 'id' => $li['sid']), array('logo', 'storename'));

			if ($li['fkid']) {
				$li['title'] = pdo_getcolumn(PDO_NAME . 'halfcardlist', array('uniacid' => $_W['uniacid'], 'id' => $li['fkid']), 'title');
			}
			else {
				$li['title'] = $store['storename'] . 'ä¹°å®¶å¨çº¿ä¹°å';
			}

			$li['paytime'] = date('Y-m-d H:i:s', $li['paytime']);
		}

		$filter = array('orderno' => 'è®¢åå·', 'title' => 'æå±åå®¶', 'nickname' => 'ä¹°å®¶æµç§°', 'mobile' => 'ä¹°å®¶çµè¯', 'goodsprice' => 'è®¢åéé¢', 'oprice' => 'ä¸å¯ä¼æ éé¢', 'spec' => 'ä¼æ ææ£', 'card_fee' => 'å·²ä¼æ éé¢', 'price' => 'å®ä»éé¢', 'paytype' => 'æ¯ä»æ¹å¼', 'paytime' => 'æ¯ä»æ¶é´');
		$data = array();
		$i = 0;

		while ($i < count($list)) {
			foreach ($filter as $key => $title) {
				if ($key == 'paytype') {
					switch ($list[$i][$key]) {
					case '1':
						$data[$i][$key] = 'ä½é¢æ¯ä»';
						break;

					case '2':
						$data[$i][$key] = 'å¾®ä¿¡æ¯ä»';
						break;

					case '3':
						$data[$i][$key] = 'æ¯ä»å®æ¯ä»';
						break;

					case '4':
						$data[$i][$key] = 'è´§å°ä»æ¬¾';
						break;

					default:
						$data[$i][$key] = 'å¶ä»ææªæ¯ä»';
						break;
					}
				}
				else if ($key == 'spec') {
					if ($list[$i][$key] < 10) {
						$data[$i][$key] = $list[$i][$key] . 'æ';
					}
					else {
						$data[$i][$key] = 'æ ææ£';
					}
				}
				else {
					$data[$i][$key] = $list[$i][$key];
				}
			}

			++$i;
		}

		util_csv::export_csv_2($data, $filter, 'å¨çº¿ä¹°åè®°å½è¡¨.csv');
		exit();
	}

	public function freightlist()
	{
		global $_W;
		global $_GPC;
		$pindex = max(1, intval($_GPC['page']));
		$psize = 10;
		$wheres = array();
		$wheres['uniacid'] = $_W['uniacid'];

		if (is_agent()) {
			$wheres['aid'] = $_W['aid'];
		}

		$freightlist = Store::getNumExpress('*', $wheres, 'ID DESC', $pindex, $psize, 1);
		$pager = $freightlist[1];
		$list = $freightlist[0];
		include wl_template('order/freightlist');
	}

	public function creatfreight()
	{
		global $_W;
		global $_GPC;
		$id = $_GPC['id'];

		if (!is_agent()) {
			$agents = pdo_getall('wlmerchant_agentusers', array('uniacid' => $_W['uniacid']), array('id', 'agentname'));
		}

		if ($id) {
			$info = pdo_get('wlmerchant_express_template', array('id' => $id));
			$info['expressarray'] = unserialize($info['expressarray']);
		}

		if (checksubmit('submit')) {
			$data['name'] = htmlspecialchars($_GPC['expressname']);
			$data['defaultnum'] = intval($_GPC['defaultnum']);
			$data['defaultmoney'] = sprintf('%.2f', $_GPC['defaultmoney']);
			$data['defaultnumex'] = intval($_GPC['defaultnumex']);
			$data['defaultmoneyex'] = sprintf('%.2f', $_GPC['defaultmoneyex']);
			if (!empty($_GPC['express']['area']) && is_array($_GPC['express']['area'])) {
				foreach ($_GPC['express']['area'] as $k => $v) {
					$expressarray[] = array('area' => $v, 'num' => intval($_GPC['express']['num'][$k]), 'money' => sprintf('%.2f', $_GPC['express']['money'][$k]), 'numex' => intval($_GPC['express']['numex'][$k]), 'moneyex' => sprintf('%.2f', $_GPC['express']['moneyex'][$k]));
				}
			}

			$data['expressarray'] = serialize($expressarray);
			$data['createtime'] = time();

			if ($_GPC['aid']) {
				$data['aid'] = $_GPC['aid'];
			}
			else {
				$data['aid'] = $_W['aid'];
			}

			if ($id) {
				$res = Store::updateExpress($data, $id);

				if ($res) {
					wl_message('æ´æ°è¿è´¹æ¨¡æ¿æå', web_url('order/wlOrder/freightlist'), 'success');
				}
				else {
					wl_message('æ´æ°è¿è´¹æ¨¡æ¿å¤±è´¥', referer(), 'error');
				}
			}
			else {
				$res = Store::saveExpress($data);

				if ($res) {
					wl_message('åå»ºè¿è´¹æ¨¡æ¿æå', web_url('order/wlOrder/freightlist'), 'success');
				}
				else {
					wl_message('åå»ºè¿è´¹æ¨¡æ¿å¤±è´¥', referer(), 'error');
				}
			}
		}

		include wl_template('order/creatfreight');
	}

	public function deleteExpress()
	{
		global $_W;
		global $_GPC;
		$id = $_GPC['id'];
		$res = Store::deteleExpress($id);

		if ($res) {
			exit(json_encode(array('errno' => 0, 'message' => $res, 'id' => $id)));
		}
		else {
			exit(json_encode(array('errno' => 2, 'message' => $res, 'id' => $id)));
		}
	}

	public function delerefund()
	{
		global $_W;
		global $_GPC;
		$id = $_GPC['id'];
		$type = $_GPC['type'];

		if ($type == 'a') {
			$res = pdo_update('wlmerchant_order', array('applyrefund' => 0), array('id' => $id));
		}
		else {
			$res = pdo_update('wlmerchant_rush_order', array('applyrefund' => 0), array('id' => $id));
		}

		if ($res) {
			show_json(1);
		}
		else {
			show_json(0, 'é©³åå¤±è´¥ï¼è¯·éè¯');
		}
	}

	public function send()
	{
		global $_W;
		global $_GPC;
		$id = $_GPC['id'];
		$type = $_GPC['type'];
		$settings = Setting::wlsetting_read('orderset');
		$edit_flag = $_GPC['edit_flag'];

		if ($type == 'a') {
			$expressid = pdo_getcolumn(PDO_NAME . 'order', array('id' => $id), 'expressid');
		}
		else if ($type == 'consumption') {
			$expressid = pdo_getcolumn(PDO_NAME . 'consumption_record', array('id' => $id), 'expressid');
		}
		else {
			$expressid = pdo_getcolumn(PDO_NAME . 'rush_order', array('id' => $id), 'expressid');
		}

		if (empty($expressid)) {
			show_json(0, 'æ æ¶è´§å°åï¼æ æ³åè´§ï¼');
		}

		$express = pdo_get(PDO_NAME . 'express', array('id' => $expressid));

		if ($_W['ispost']) {
			if (empty($_GPC['expresssn'])) {
				show_json(0, 'è¯·è¾å¥å¿«éåå·ï¼');
			}

			$expressname = $_GPC['express'];
			$expresssn = $_GPC['expresssn'];
			$res = pdo_update('wlmerchant_express', array('expressname' => $expressname, 'expresssn' => $expresssn, 'orderid' => $id, 'sendtime' => time()), array('id' => $expressid));

			if ($res) {
				if ($type == 'a') {
					$res = pdo_update('wlmerchant_order', array('status' => 4), array('id' => $id));

					if (0 < $settings['receipt']) {
						if ($edit_flag) {
							pdo_delete('wlmerchant_waittask', array('important' => $id, 'key' => 6, 'status' => 0));
						}

						$receipttime = time() + $settings['receipt'] * 24 * 3600;
						$task = array('type' => 'order', 'orderid' => $id);
						$task = serialize($task);
						Queue::addTask(6, $task, $receipttime, $id);
					}

					Message::sendremind($id, 'a');
				}
				else if ($type == 'consumption') {
					$res = pdo_update('wlmerchant_consumption_record', array('status' => 2), array('id' => $id));

					if (0 < $settings['receipt']) {
						if ($edit_flag) {
							pdo_delete('wlmerchant_waittask', array('important' => $id, 'key' => 6, 'status' => 0));
						}

						$receipttime = time() + $settings['receipt'] * 24 * 3600;
						$task = array('type' => 'consumption', 'orderid' => $id);
						$task = serialize($task);
						Queue::addTask(6, $task, $receipttime, $id);
					}
				}
				else {
					$res = pdo_update('wlmerchant_rush_order', array('status' => 4), array('id' => $id));

					if (0 < $settings['receipt']) {
						if ($edit_flag) {
							pdo_delete('wlmerchant_waittask', array('important' => $id, 'key' => 6, 'status' => 0));
						}

						$receipttime = time() + $settings['receipt'] * 24 * 3600;
						$task = array('type' => 'rush', 'orderid' => $id);
						$task = serialize($task);
						Queue::addTask(6, $task, $receipttime, $id);
					}

					Message::sendremind($id, 'b');
				}

				show_json(1);
			}
			else {
				show_json(0, 'åè´§å¤±è´¥è¯·éè¯');
			}
		}

		$express_list = array(
			array(name => 'é¡ºä¸°', express => 'shunfeng'),
			array(name => 'ç³é', express => 'shentong'),
			array(name => 'éµè¾¾å¿«è¿', express => 'yunda'),
			array(name => 'å¤©å¤©å¿«é', express => 'tiantian'),
			array(name => 'åééé', express => 'yuantong'),
			array(name => 'ä¸­ééé', express => 'zhongtong'),
			array(name => 'emså¿«é', express => 'ems'),
			array(name => 'æ±éå¿«è¿', express => 'huitongkuaidi'),
			array(name => 'å¨å³°å¿«é', express => 'quanfengkuaidi'),
			array(name => 'å®æ¥é', express => 'zhaijisong'),
			array(name => 'aaeå¨çä¸é', express => 'aae'),
			array(name => 'å®æ·å¿«é', express => 'anjie'),
			array(name => 'å®ä¿¡è¾¾å¿«é', express => 'anxindakuaixi'),
			array(name => 'å½ªè®°å¿«é', express => 'biaojikuaidi'),
			array(name => 'bht', express => 'bht'),
			array(name => 'ç¾ç¦ä¸æ¹å½éç©æµ', express => 'baifudongfang'),
			array(name => 'ä¸­å½ä¸æ¹ï¼COEï¼', express => 'coe'),
			array(name => 'é¿å®ç©æµ', express => 'changyuwuliu'),
			array(name => 'å¤§ç°ç©æµ', express => 'datianwuliu'),
			array(name => 'å¾·é¦ç©æµ', express => 'debangwuliu'),
			array(name => 'dhl', express => 'dhl'),
			array(name => 'dpex', express => 'dpex'),
			array(name => 'déå¿«é', express => 'dsukuaidi'),
			array(name => 'éåæ¹', express => 'disifang'),
			array(name => 'fedexï¼å½å¤ï¼', express => 'fedex'),
			array(name => 'é£åº·è¾¾ç©æµ', express => 'feikangda'),
			array(name => 'å¤å°å¿«é', express => 'fenghuangkuaidi'),
			array(name => 'é£å¿«è¾¾', express => 'feikuaida'),
			array(name => 'å½éå¿«é', express => 'guotongkuaidi'),
			array(name => 'æ¸¯ä¸­è½è¾¾ç©æµ', express => 'ganzhongnengda'),
			array(name => 'å¹¿ä¸é®æ¿ç©æµ', express => 'guangdongyouzhengwuliu'),
			array(name => 'å±éè¾¾', express => 'gongsuda'),
			array(name => 'æè·¯ç©æµ', express => 'hengluwuliu'),
			array(name => 'åå¤é¾ç©æµ', express => 'huaxialongwuliu'),
			array(name => 'æµ·çº¢', express => 'haihongwangsong'),
			array(name => 'æµ·å¤ç¯ç', express => 'haiwaihuanqiu'),
			array(name => 'ä½³æ¡ç©æµ', express => 'jiayiwuliu'),
			array(name => 'äº¬å¹¿éé', express => 'jinguangsudikuaijian'),
			array(name => 'æ¥åè¾¾', express => 'jixianda'),
			array(name => 'ä½³åç©æµ', express => 'jjwl'),
			array(name => 'å è¿ç¾ç©æµ', express => 'jymwl'),
			array(name => 'éå¤§ç©æµ', express => 'jindawuliu'),
			array(name => 'åéå¤§é', express => 'jialidatong'),
			array(name => 'æè¶å¿«é', express => 'jykd'),
			array(name => 'å¿«æ·éé', express => 'kuaijiesudi'),
			array(name => 'èé¦å¿«éï¼å½åï¼', express => 'lianb'),
			array(name => 'èæéç©æµ', express => 'lianhaowuliu'),
			array(name => 'é¾é¦ç©æµ', express => 'longbanwuliu'),
			array(name => 'ç«å³é', express => 'lijisong'),
			array(name => 'ä¹æ·é', express => 'lejiedi'),
			array(name => 'æ°èªå¿«é', express => 'minghangkuaidi'),
			array(name => 'ç¾å½å¿«é', express => 'meiguokuaidi'),
			array(name => 'é¨å¯¹é¨', express => 'menduimen'),
			array(name => 'OCS', express => 'ocs'),
			array(name => 'éæè´§è¿', express => 'peisihuoyunkuaidi'),
			array(name => 'å¨æ¨å¿«é', express => 'quanchenkuaidi'),
			array(name => 'å¨ééç©æµ', express => 'quanjitong'),
			array(name => 'å¨æ¥éå¿«é', express => 'quanritongkuaidi'),
			array(name => 'å¨ä¸å¿«é', express => 'quanyikuaidi'),
			array(name => 'å¦é£è¾¾', express => 'rufengda'),
			array(name => 'ä¸æéé', express => 'santaisudi'),
			array(name => 'çè¾ç©æµ', express => 'shenghuiwuliu'),
			array(name => 'éå°ç©æµ', express => 'sue'),
			array(name => 'çä¸°ç©æµ', express => 'shengfeng'),
			array(name => 'èµæ¾³é', express => 'saiaodi'),
			array(name => 'å¤©å°åå®', express => 'tiandihuayu'),
			array(name => 'tnt', express => 'tnt'),
			array(name => 'ups', express => 'ups'),
			array(name => 'ä¸å®¶ç©æµ', express => 'wanjiawuliu'),
			array(name => 'ææ·èªç©ºéé', express => 'wenjiesudi'),
			array(name => 'ä¼å', express => 'wuyuan'),
			array(name => 'ä¸è±¡ç©æµ', express => 'wxwl'),
			array(name => 'æ°é¦ç©æµ', express => 'xinbangwuliu'),
			array(name => 'ä¿¡ä¸°ç©æµ', express => 'xinfengwuliu'),
			array(name => 'äºé£éé', express => 'yafengsudi'),
			array(name => 'ä¸é¦éé', express => 'yibangwuliu'),
			array(name => 'ä¼éç©æµ', express => 'youshuwuliu'),
			array(name => 'é®æ¿åè£¹æå·ä¿¡', express => 'youzhengguonei'),
			array(name => 'é®æ¿å½éåè£¹æå·ä¿¡', express => 'youzhengguoji'),
			array(name => 'è¿æç©æµ', express => 'yuanchengwuliu'),
			array(name => 'æºä¼ä¸°å¿«é', express => 'yuanweifeng'),
			array(name => 'åæºæ·è¯å¿«é', express => 'yuanzhijiecheng'),
			array(name => 'è¿éå¿«é', express => 'yuntongkuaidi'),
			array(name => 'è¶ä¸°ç©æµ', express => 'yuefengwuliu'),
			array(name => 'æºå®è¾¾', express => 'yad'),
			array(name => 'é¶æ·éé', express => 'yinjiesudi'),
			array(name => 'ä¸­éå¿«è¿', express => 'zhongtiekuaiyun'),
			array(name => 'ä¸­é®ç©æµ', express => 'zhongyouwuliu'),
			array(name => 'å¿ ä¿¡è¾¾', express => 'zhongxinda'),
			array(name => 'èéº»å¼é¨', express => 'zhimakaimen')
		);
		include wl_template('order/send');
	}

	public function changeprice()
	{
		global $_W;
		global $_GPC;
		$id = $_GPC['id'];
		$type = $_GPC['type'];

		if ($type == 'a') {
			$order = pdo_get('wlmerchant_order', array('id' => $id), array('expressid', 'price', 'originalprice', 'changeprice', 'changedispatchprice'));

			if (0 < $order['originalprice']) {
				$price = $order['originalprice'];
			}
			else {
				$price = $order['price'];
			}
		}
		else {
			$order = pdo_get('wlmerchant_rush_order', array('id' => $id), array('expressid', 'price', 'actualprice', 'originalprice', 'changeprice', 'changedispatchprice'));

			if (0 < $order['originalprice']) {
				$price = $order['originalprice'];
			}
			else {
				$price = $order['price'];
			}
		}

		if ($_W['ispost']) {
			$price_type = $_GPC['price_type'];
			$price_value = trim($_GPC['price_value']);
			$price_value = sprintf('%.2f', $price_value);
			$express_type = $_GPC['express_type'];
			$express_value = $_GPC['express_value'];
			$express_value = sprintf('%.2f', $express_value);

			if ($price_type == 2) {
				$price_value = 0 - $price_value;
			}

			if ($express_type == 2) {
				$express_value = 0 - $express_value;
			}

			$newprice = $price + $price_value + $express_value;
			if ($newprice < 0 || $newprice == 0) {
				show_json(0, 'æ¹ä»·å¤±è´¥ï¼æ¹ä»·åè®¢åéé¢ä¸è½å°äºæç­äº0');
			}

			if ($type == 'a') {
				$res = pdo_update('wlmerchant_order', array('price' => $newprice, 'changeprice' => $price_value, 'changedispatchprice' => $express_value, 'originalprice' => $price, 'orderno' => createUniontid()), array('id' => $id));
			}
			else {
				$res = pdo_update('wlmerchant_rush_order', array('actualprice' => $newprice, 'changeprice' => $price_value, 'changedispatchprice' => $express_value, 'originalprice' => $price, 'orderno' => createUniontid()), array('id' => $id));
			}

			if ($res) {
				show_json(1);
			}
			else {
				show_json(0, 'æ¹ä»·å¤±è´¥,è¯·éè¯');
			}
		}

		include wl_template('order/changeprice');
	}

	public function changecommission()
	{
		global $_W;
		global $_GPC;
		$id = $_GPC['id'];
		$order = pdo_get('wlmerchant_disorder', array('id' => $id));
		$leadmoney = unserialize($order['leadmoney']);
		$order['onemember'] = pdo_getcolumn(PDO_NAME . 'distributor', array('id' => $order['oneleadid']), 'nickname');

		if ($order['twoleadid']) {
			$order['twomember'] = pdo_getcolumn(PDO_NAME . 'distributor', array('id' => $order['twoleadid']), 'nickname');
		}

		if ($_W['ispost']) {
			$onemoney = $_GPC['onemoney'];
			$twomoney = $_GPC['twomoney'];
			if ($onemoney < 0 || $twomoney < 0) {
				show_json(0, 'åéä½£éä¸è½ä¸º0,è¯·éè¯');
			}

			if ($order['neworderflag']) {
				$num = pdo_fetchcolumn('SELECT count(id) FROM ' . tablename('wlmerchant_smallorder') . (' WHERE disorderid = ' . $id));
				$newone = sprintf('%.2f', $onemoney / $num);
				$newtow = sprintf('%.2f', $twomoney / $num);
				pdo_update('wlmerchant_smallorder', array('onedismoney' => $newone, 'twodismoney' => $newtow), array('disorderid' => $id, 'status' => 1));
			}

			$newleadmoney['one'] = $onemoney;
			$newleadmoney['two'] = $twomoney;
			$newleadmoney = serialize($newleadmoney);
			$res = pdo_update('wlmerchant_disorder', array('leadmoney' => $newleadmoney), array('id' => $id));

			if ($res) {
				show_json(1);
			}
			else {
				show_json(0, 'ä¿®æ¹å¤±è´¥,è¯·éè¯');
			}
		}

		include wl_template('order/changecommission');
	}

	public function changetime()
	{
		global $_W;
		global $_GPC;
		$id = $_GPC['id'];
		$type = $_GPC['type'];

		if ($type == 'a') {
			$order = pdo_get('wlmerchant_order', array('id' => $id), array('id', 'aid', 'sid', 'plugin', 'estimatetime', 'recordid', 'fkid', 'issettlement', 'orderno'));

			if ($order['plugin'] == 'wlfightgroup') {
				$plugin = 2;
			}

			if ($order['plugin'] == 'coupon') {
				$plugin = 3;
			}

			if ($order['plugin'] == 'groupon') {
				$plugin = 10;
			}
		}
		else {
			$order = pdo_get('wlmerchant_rush_order', array('id' => $id), array('id', 'aid', 'sid', 'estimatetime', 'activityid', 'issettlement', 'orderno'));
			$plugin = 1;
		}

		if ($_W['ispost']) {
			$time = strtotime($_GPC['estimatetime']);

			if ($type == 'a') {
				if ($_GPC['classtype']) {
					$orders = pdo_getall('wlmerchant_order', array('fkid' => $order['fkid'], 'plugin' => $order['plugin'], 'issettlement' => 1, 'status' => 9), array('orderno', 'id', 'aid', 'sid', 'issettlement', 'plugin'));

					foreach ($orders as $key => $aor) {
						$settlement = pdo_get('wlmerchant_autosettlement_record', array('orderid' => $aor['id'], 'type' => $plugin));

						if (0 < $settlement['agentmoney']) {
							pdo_fetch('update' . tablename('wlmerchant_agentusers') . ('SET allmoney=allmoney-' . $settlement['agentmoney'] . ',nowmoney=nowmoney-' . $settlement['agentmoney'] . ' WHERE id = ' . $aor['aid']));
							$changeagentnowmoney = pdo_getcolumn(PDO_NAME . 'agentusers', array('id' => $aor['aid']), 'nowmoney');
							Store::addcurrent(2, -1, $aor['aid'], 0 - $settlement['agentmoney'], $changeagentnowmoney, '', 'åå°ä¿®æ¹[' . $aor['orderno'] . ']è®¢åæ¶éæ£é¤å·²ç»ç®éé¢');
						}

						if (0 < $settlement['merchantmoney']) {
							pdo_fetch('update' . tablename('wlmerchant_merchantdata') . ('SET allmoney=allmoney-' . $settlement['merchantmoney'] . ',nowmoney=nowmoney-' . $settlement['merchantmoney'] . ' WHERE id = ' . $aor['sid']));
							$changemerchantnowmoney = pdo_getcolumn(PDO_NAME . 'merchantdata', array('id' => $aor['sid']), 'nowmoney');
							Store::addcurrent(1, -1, $aor['sid'], 0 - $settlement['merchantmoney'], $changemerchantnowmoney, '', 'åå°ä¿®æ¹[' . $aor['orderno'] . ']è®¢åæ¶éæ£é¤å·²ç»ç®éé¢');
						}

						pdo_delete('wlmerchant_autosettlement_record', array('id' => $settlement['id']));
					}

					$res2 = pdo_update('wlmerchant_order', array('estimatetime' => $time), array('fkid' => $order['fkid'], 'plugin' => $order['plugin'], 'status' => 1));
					$res1 = pdo_update('wlmerchant_order', array('estimatetime' => $time, 'status' => 1, 'issettlement' => 0), array('fkid' => $order['fkid'], 'plugin' => $order['plugin'], 'status' => 9));
					if ($order['plugin'] == 'coupon' && ($res1 || $res2)) {
						pdo_update('wlmerchant_member_coupons', array('endtime' => $time), array('parentid' => $order['fkid'], 'status' => 1));
						pdo_update('wlmerchant_member_coupons', array('endtime' => $time, 'status' => 1), array('parentid' => $order['fkid'], 'status' => 3));
					}
				}
				else {
					if ($order['issettlement']) {
						$settlement = pdo_get('wlmerchant_autosettlement_record', array('orderid' => $order['id'], 'type' => $plugin));

						if (0 < $settlement['agentmoney']) {
							pdo_fetch('update' . tablename('wlmerchant_agentusers') . ('SET allmoney=allmoney-' . $settlement['agentmoney'] . ',nowmoney=nowmoney-' . $settlement['agentmoney'] . ' WHERE id = ' . $order['aid']));
							$changeagentnowmoney = pdo_getcolumn(PDO_NAME . 'agentusers', array('id' => $order['aid']), 'nowmoney');
							Store::addcurrent(2, -1, $order['aid'], 0 - $settlement['agentmoney'], $changeagentnowmoney, '', 'åå°ä¿®æ¹[' . $order['orderno'] . ']è®¢åæ¶éæ£é¤å·²ç»ç®éé¢');
						}

						if (0 < $settlement['merchantmoney']) {
							pdo_fetch('update' . tablename('wlmerchant_merchantdata') . ('SET allmoney=allmoney-' . $settlement['merchantmoney'] . ',nowmoney=nowmoney-' . $settlement['merchantmoney'] . ' WHERE id = ' . $order['sid']));
							$changemerchantnowmoney = pdo_getcolumn(PDO_NAME . 'merchantdata', array('id' => $order['sid']), 'nowmoney');
							Store::addcurrent(1, -1, $order['sid'], 0 - $settlement['merchantmoney'], $changemerchantnowmoney, '', 'åå°ä¿®æ¹[' . $order['orderno'] . ']è®¢åæ¶éæ£é¤å·²ç»ç®éé¢');
						}

						pdo_delete('wlmerchant_autosettlement_record', array('id' => $settlement['id']));
					}

					$res1 = pdo_update('wlmerchant_order', array('estimatetime' => $time, 'status' => 1, 'issettlement' => 0), array('id' => $id));
					if ($order['plugin'] == 'coupon' && $res1) {
						pdo_update('wlmerchant_member_coupons', array('endtime' => $time, 'status' => 1), array('id' => $order['recordid']));
					}
				}
			}
			else if ($_GPC['classtype']) {
				$orders = pdo_getall('wlmerchant_rush_order', array('activityid' => $order['activityid'], 'issettlement' => 1, 'status' => 9), array('id', 'aid', 'sid', 'issettlement', 'orderno'));

				foreach ($orders as $key => $aor) {
					$settlement = pdo_get('wlmerchant_autosettlement_record', array('orderid' => $aor['id'], 'type' => $plugin));

					if (0 < $settlement['agentmoney']) {
						pdo_fetch('update' . tablename('wlmerchant_agentusers') . ('SET allmoney=allmoney-' . $settlement['agentmoney'] . ',nowmoney=nowmoney-' . $settlement['agentmoney'] . ' WHERE id = ' . $aor['aid']));
						$changeagentnowmoney = pdo_getcolumn(PDO_NAME . 'agentusers', array('id' => $aor['aid']), 'nowmoney');
						Store::addcurrent(2, -1, $aor['aid'], 0 - $settlement['agentmoney'], $changeagentnowmoney, '', 'åå°ä¿®æ¹[' . $aor['orderno'] . ']è®¢åæ¶éæ£é¤å·²ç»ç®éé¢');
					}

					if (0 < $settlement['merchantmoney']) {
						pdo_fetch('update' . tablename('wlmerchant_merchantdata') . ('SET allmoney=allmoney-' . $settlement['merchantmoney'] . ',nowmoney=nowmoney-' . $settlement['merchantmoney'] . ' WHERE id = ' . $aor['sid']));
						$changemerchantnowmoney = pdo_getcolumn(PDO_NAME . 'merchantdata', array('id' => $aor['sid']), 'nowmoney');
						Store::addcurrent(1, -1, $aor['sid'], 0 - $settlement['merchantmoney'], $changemerchantnowmoney, '', 'åå°ä¿®æ¹[' . $aor['orderno'] . ']è®¢åæ¶éæ£é¤å·²ç»ç®éé¢');
					}

					pdo_delete('wlmerchant_autosettlement_record', array('id' => $settlement['id']));
				}

				$res2 = pdo_update('wlmerchant_rush_order', array('estimatetime' => $time), array('activityid' => $order['activityid'], 'status' => 1));
				$res1 = pdo_update('wlmerchant_rush_order', array('estimatetime' => $time, 'status' => 1, 'issettlement' => 0), array('activityid' => $order['activityid'], 'status' => 9));
			}
			else {
				if ($order['issettlement']) {
					$settlement = pdo_get('wlmerchant_autosettlement_record', array('orderid' => $order['id'], 'type' => $plugin));

					if (0 < $settlement['agentmoney']) {
						pdo_fetch('update' . tablename('wlmerchant_agentusers') . ('SET allmoney=allmoney-' . $settlement['agentmoney'] . ',nowmoney=nowmoney-' . $settlement['agentmoney'] . ' WHERE id = ' . $order['aid']));
						$changeagentnowmoney = pdo_getcolumn(PDO_NAME . 'agentusers', array('id' => $order['aid']), 'nowmoney');
						Store::addcurrent(2, -1, $order['aid'], 0 - $settlement['agentmoney'], $changeagentnowmoney, '', 'åå°ä¿®æ¹[' . $order['orderno'] . ']è®¢åæ¶éæ£é¤å·²ç»ç®éé¢');
					}

					if (0 < $settlement['merchantmoney']) {
						pdo_fetch('update' . tablename('wlmerchant_merchantdata') . ('SET allmoney=allmoney-' . $settlement['merchantmoney'] . ',nowmoney=nowmoney-' . $settlement['merchantmoney'] . ' WHERE id = ' . $order['sid']));
						$changemerchantnowmoney = pdo_getcolumn(PDO_NAME . 'merchantdata', array('id' => $order['sid']), 'nowmoney');
						Store::addcurrent(1, -1, $order['sid'], 0 - $settlement['merchantmoney'], $changemerchantnowmoney, '', 'åå°ä¿®æ¹[' . $order['orderno'] . ']è®¢åæ¶éæ£é¤å·²ç»ç®éé¢');
					}

					pdo_delete('wlmerchant_autosettlement_record', array('id' => $settlement['id']));
				}

				$res1 = pdo_update('wlmerchant_rush_order', array('estimatetime' => $time, 'status' => 1, 'issettlement' => 0), array('id' => $id));
			}

			if ($res1 || $res2) {
				show_json(1);
			}
			else {
				show_json(0, 'ä¿®æ¹å¤±è´¥,è¯·éè¯');
			}
		}

		include wl_template('order/changetime');
	}

	public function collect()
	{
		global $_W;
		global $_GPC;
		$id = $_GPC['id'];
		$type = $_GPC['type'];

		if ($type == 'a') {
			$expressid = pdo_getcolumn(PDO_NAME . 'order', array('id' => $id), 'expressid');
		}
		else if ($type == 'consumption') {
			$expressid = pdo_getcolumn(PDO_NAME . 'consumption_record', array('id' => $id), 'expressid');
		}
		else {
			$expressid = pdo_getcolumn(PDO_NAME . 'rush_order', array('id' => $id), 'expressid');
		}

		if (empty($expressid)) {
			show_json(0, 'æ æ¶è´§ä¿¡æ¯ï¼æ æ³æ¶è´§ï¼');
		}

		$express = pdo_get(PDO_NAME . 'express', array('id' => $expressid));
		$res = pdo_update('wlmerchant_express', array('receivetime' => time()), array('id' => $expressid));

		if ($res) {
			if ($type == 'a') {
				pdo_update('wlmerchant_order', array('status' => 2), array('id' => $id));
				$plugin = pdo_getcolumn(PDO_NAME . 'order', array('id' => $id), 'plugin');
				$ordertask = array('type' => $plugin, 'orderid' => $id);
				$ordertask = serialize($ordertask);
				Queue::addTask(2, $ordertask, time(), $id);
				$disorderid = pdo_getcolumn(PDO_NAME . 'order', array('id' => $id), 'disorderid');
			}
			else if ($type == 'consumption') {
				pdo_update('wlmerchant_consumption_record', array('status' => 3), array('id' => $id));
				$orderid = pdo_getcolumn(PDO_NAME . 'consumption_record', array('id' => $id), 'orderid');
				$plugin = 'consumption';
				$disorderid = pdo_getcolumn(PDO_NAME . 'order', array('id' => $orderid), 'disorderid');
			}
			else {
				pdo_update('wlmerchant_rush_order', array('status' => 2), array('id' => $id));
				$plugin = 'rush';
				$rushtask = array('type' => 'rush', 'orderid' => $id);
				$rushtask = serialize($rushtask);
				Queue::addTask(1, $rushtask, time(), $id);
				$disorderid = pdo_getcolumn(PDO_NAME . 'rush_order', array('id' => $id), 'disorderid');
			}

			if ($disorderid) {
				$res = pdo_update('wlmerchant_disorder', array('status' => 1), array('id' => $disorderid, 'status' => 0));

				if ($res) {
					$distask = array('type' => $plugin, 'orderid' => $disorderid);
					$distask = serialize($distask);
					Queue::addTask(3, $distask, time(), $disorderid);
				}
			}

			show_json(1);
		}
		else {
			show_json(0, 'æ¶è´§å¤±è´¥è¯·éè¯');
		}
	}

	public function sendcancel()
	{
		global $_W;
		global $_GPC;
		$id = $_GPC['id'];
		$type = $_GPC['type'];
		$settings = Setting::wlsetting_read('orderset');

		if ($type == 'a') {
			$res = pdo_update('wlmerchant_order', array('status' => 8), array('id' => $id));
			$expressid = pdo_getcolumn(PDO_NAME . 'order', array('id' => $id), 'expressid');
		}
		else if ($type == 'consumption') {
			$res = pdo_update('wlmerchant_consumption_record', array('status' => 1), array('id' => $id));
			$expressid = pdo_getcolumn(PDO_NAME . 'consumption_record', array('id' => $id), 'expressid');
		}
		else {
			$res = pdo_update('wlmerchant_rush_order', array('status' => 8), array('id' => $id));
			$expressid = pdo_getcolumn(PDO_NAME . 'rush_order', array('id' => $id), 'expressid');
		}

		pdo_update('wlmerchant_express', array('expressname' => '', 'expresssn' => '', 'sendtime' => 0), array('id' => $expressid));

		if (0 < $settings['receipt']) {
			pdo_delete('wlmerchant_waittask', array('important' => $id, 'key' => 6, 'status' => 0));
		}

		if ($res) {
			show_json(1);
		}
		else {
			show_json(0, 'åæ¶å¤±è´¥è¯·éè¯');
		}
	}

	public function express()
	{
		global $_W;
		global $_GPC;
		$express = $_GPC['express'];
		$expresssn = $_GPC['expresssn'];
		$express == 'jymwl' ? 'jiayunmeiwuliu' : $express;
		$express == 'TTKD' ? 'tiantian' : $express;
		$express == 'jjwl' ? 'jiajiwuliu' : $express;
		$express == 'zhongtiekuaiyun' ? 'ztky' : $express;
		$url = 'https://www.kuaidi100.com/chaxun?com=' . $express . '&nu=' . $expresssn;
		$response = ihttp_request($url);
		$content = $response['content'];
		$info = json_decode($content, true);
		$list = array();
		if (!empty($info['data']) && is_array($info['data'])) {
			foreach ($info['data'] as $index => $data) {
				$list[] = array('time' => trim($data['time']), 'step' => trim($data['context']));
			}
		}

		include wl_template('order/express');
	}

	public function hexiaorecord()
	{
		global $_W;
		global $_GPC;
		$id = $_GPC['id'];
		$type = $_GPC['type'];

		if ($type == 'a') {
			$order = pdo_get('wlmerchant_order', array('id' => $id), array('plugin', 'recordid', 'specid', 'neworderflag'));

			if ($order['neworderflag']) {
				$usetimes = pdo_fetchcolumn('SELECT count(id) FROM ' . tablename('wlmerchant_smallorder') . (' WHERE plugin = \'' . $order['plugin'] . '\' AND  orderid = ' . $id . ' AND status = 1'));
				$smallorder = pdo_getall('wlmerchant_smallorder', array('orderid' => $id, 'plugin' => $order['plugin']), '', '', 'status ASC,hexiaotime ASC');
			}
			else if ($order['plugin'] == 'wlfightgroup') {
				$record = pdo_get('wlmerchant_fightgroup_userecord', array('id' => $order['recordid']), array('usetimes', 'usedtime'));
				$usetimes = $record['usetimes'];
				$usedtime = unserialize($record['usedtime']);
			}
			else if ($order['plugin'] == 'coupon') {
				$record = pdo_get('wlmerchant_member_coupons', array('id' => $order['recordid']), array('usetimes', 'usedtime'));
				$usetimes = $record['usetimes'];
				$usedtime = unserialize($record['usedtime']);
			}
			else if ($order['plugin'] == 'groupon') {
				$record = pdo_get('wlmerchant_groupon_userecord', array('id' => $order['recordid']), array('usetimes', 'usedtime'));
				$usetimes = $record['usetimes'];
				$usedtime = unserialize($record['usedtime']);
			}
			else {
				if ($order['plugin'] == 'bargain') {
					$record = pdo_get('wlmerchant_bargain_userlist', array('id' => $order['specid']), array('usetimes', 'usedtime'));
					$usetimes = $record['usetimes'];
					$usedtime = unserialize($record['usedtime']);
				}
			}
		}
		else {
			$order = pdo_get('wlmerchant_rush_order', array('id' => $id), array('usetimes', 'usedtime', 'neworderflag'));

			if ($order['neworderflag']) {
				$usetimes = pdo_fetchcolumn('SELECT count(id) FROM ' . tablename('wlmerchant_smallorder') . (' WHERE plugin = \'rush\' AND  orderid = ' . $id . ' AND status = 1'));
				$smallorder = pdo_getall('wlmerchant_smallorder', array('orderid' => $id, 'plugin' => 'rush'), '', '', 'status ASC,hexiaotime ASC');
			}
			else {
				$usetimes = $order['usetimes'];
				$usedtime = unserialize($order['usedtime']);
			}
		}

		if ($smallorder) {
			$usedtime = array();

			foreach ($smallorder as $key => $sm) {
				$va['status'] = $sm['status'];

				if ($sm['status'] == 2) {
					$va['time'] = date('Y-m-d H:i:s', $sm['hexiaotime']);
				}
				else {
					if ($sm['status'] == 3) {
						$va['time'] = date('Y-m-d H:i:s', $sm['refundtime']);
					}
				}

				if ($sm['hxuid']) {
					$va['ver'] = pdo_getcolumn(PDO_NAME . 'merchantuser', array('id' => $sm['hxuid']), 'name');
				}
				else {
					$va['ver'] = 'æ ';
				}

				switch ($sm['hexiaotype']) {
				case '1':
					$va['type'] = 'è¾ç æ ¸é';
					break;

				case '2':
					$va['type'] = 'æ«ç æ ¸é';
					break;

				case '3':
					$va['type'] = 'åå°æ ¸é';
					break;

				case '4':
					$va['type'] = 'å¯ç æ ¸é';
					break;

				default:
					$va['type'] = 'æªç¥æ¹å¼';
					break;
				}

				$va['checkcode'] = $sm['checkcode'];
				$usedtime[] = $va;
			}
		}
		else {
			if ($usedtime) {
				foreach ($usedtime as $key => &$va) {
					$va['status'] = 2;
					$va['time'] = date('Y-m-d H:i:s', $va['time']);
					$va['ver'] = pdo_getcolumn(PDO_NAME . 'merchantuser', array('mid' => $va['ver']), 'name');

					if (empty($va['ver'])) {
						$va['ver'] = pdo_getcolumn(PDO_NAME . 'member', array('id' => $va['ver']), 'nickname');

						if (empty($va['ver'])) {
							$va['ver'] = 'æ ';
						}
					}

					switch ($va['type']) {
					case '1':
						$va['type'] = 'è¾ç æ ¸é';
						break;

					case '2':
						$va['type'] = 'æ«ç æ ¸é';
						break;

					case '3':
						$va['type'] = 'åå°æ ¸é';
						break;

					case '4':
						$va['type'] = 'å¯ç æ ¸é';
						break;

					default:
						$va['type'] = 'æªç¥æ¹å¼';
						break;
					}
				}
			}
		}

		include wl_template('order/hexiaorecord');
	}

	public function changeexpress()
	{
		global $_W;
		global $_GPC;
		$expressid = $_GPC['expressid'];
		$express = pdo_get(PDO_NAME . 'express', array('id' => $expressid));

		if ($_W['ispost']) {
			$data['name'] = trim($_GPC['name']);
			$data['tel'] = trim($_GPC['tel']);
			$data['address'] = $_GPC['address'];
			$res = pdo_update('wlmerchant_express', $data, array('id' => $expressid));

			if ($res) {
				show_json(1);
			}
			else {
				show_json(0, 'ä¿®æ¹å¤±è´¥è¯·éè¯');
			}
		}

		include wl_template('order/changeexpress');
	}

	public function fetch()
	{
		global $_W;
		global $_GPC;
		$id = $_GPC['id'];
		$type = $_GPC['type'];

		if ($type == 'a') {
			$order = pdo_get('wlmerchant_order', array('id' => $id), array('neworderflag'));
			$plugin = pdo_getcolumn(PDO_NAME . 'order', array('id' => $id), 'plugin');

			if ($order['neworderflag']) {
				if ($plugin == 'groupon') {
					$num = pdo_fetchcolumn('SELECT count(id) FROM ' . tablename('wlmerchant_smallorder') . (' WHERE plugin = \'groupon\' AND  orderid = ' . $id . ' AND status = 1'));
					$res = Groupon::hexiaoorder($id, -1, $num, 3);
				}
			}
			else if ($plugin == 'wlfightgroup') {
				$recordid = pdo_getcolumn(PDO_NAME . 'order', array('id' => $id), 'recordid');
				$num = pdo_getcolumn(PDO_NAME . 'fightgroup_userecord', array('id' => $recordid), 'usetimes');
				$res = Wlfightgroup::hexiaoorder($id, -1, $num, 3);
			}
			else if ($plugin == 'coupon') {
				$recordid = pdo_getcolumn(PDO_NAME . 'order', array('id' => $id), 'recordid');
				$num = pdo_getcolumn(PDO_NAME . 'member_coupons', array('id' => $recordid), 'usetimes');
				$res = wlCoupon::hexiaoorder($recordid, -1, $num, 3);
			}
			else if ($plugin == 'groupon') {
				$recordid = pdo_getcolumn(PDO_NAME . 'order', array('id' => $id), 'recordid');
				$num = pdo_getcolumn(PDO_NAME . 'groupon_userecord', array('id' => $recordid), 'usetimes');
				$res = Groupon::hexiaoorder($id, -1, $num, 3);
			}
			else {
				if ($plugin == 'bargain') {
					$usetimes = pdo_getcolumn(PDO_NAME . 'bargain_userlist', array('orderid' => $id), 'usetimes');
					$res = Bargain::hexiaoorder($id, -1, $usetimes, 3);
				}
			}
		}
		else {
			$item = Rush::getSingleOrder($id, '*');

			if ($item['neworderflag']) {
				$item['usetimes'] = pdo_fetchcolumn('SELECT count(id) FROM ' . tablename('wlmerchant_smallorder') . (' WHERE plugin = \'rush\' AND  orderid = ' . $id . ' AND status = 1'));
			}

			$res = Rush::hexiaoorder($id, -1, $item['usetimes'], 3);
		}

		if ($res) {
			show_json(1);
		}
		else {
			show_json(0, 'ä½¿ç¨å¤±è´¥ï¼è¯·å·æ°éè¯');
		}
	}

	public function finish()
	{
		global $_W;
		global $_GPC;
		$id = $_GPC['id'];
		$type = $_GPC['type'];

		if ($type == 'a') {
			$res = pdo_update('wlmerchant_order', array('status' => 3), array('id' => $id));
		}
		else {
			$res = pdo_update('wlmerchant_rush_order', array('status' => 3), array('id' => $id));
		}

		if ($res) {
			show_json(1);
		}
		else {
			show_json(0, 'å®æå¤±è´¥ï¼è¯·å·æ°éè¯');
		}
	}

	public function refund()
	{
		global $_W;
		global $_GPC;
		$id = $_GPC['id'];
		$type = $_GPC['type'];

		if ($_W['ispost']) {
			$unline = $_GPC['refund_type'];
			$retype = $_GPC['price_type'];

			if ($retype) {
				$money = sprintf('%.2f', $_GPC['price_value']);

				if ($money < 0.01) {
					show_json(0, 'éæ¬¾éé¢ä¸è½ä¸º0');
				}
			}
			else {
				$money = 0;
			}

			if ($type == 'a') {
				$plugin = pdo_getcolumn(PDO_NAME . 'order', array('id' => $id), 'plugin');

				if ($plugin == 'wlfightgroup') {
					$res = Wlfightgroup::refund($id, $money, $unline);
				}
				else if ($plugin == 'coupon') {
					$res = wlCoupon::refund($id, $money, $unline);
				}
				else if ($plugin == 'groupon') {
					$res = Groupon::refund($id, $money, $unline);
				}
				else {
					if ($plugin == 'bargain') {
						$res = Bargain::refund($id, $money, $unline);
					}
				}
			}
			else {
				$res = Rush::refund($id, $money, $unline);
			}

			if ($res['status']) {
				show_json(1);
			}
			else {
				show_json(0, 'éæ¬¾å¤±è´¥ï¼' . $res['message']);
			}
		}

		include wl_template('order/refund');
	}

	public function close()
	{
		global $_W;
		global $_GPC;
		$id = $_GPC['id'];
		$type = $_GPC['type'];

		if ($type == 'a') {
			$res = pdo_update('wlmerchant_order', array('status' => 5), array('id' => $id));

			if ($res) {
				$order = pdo_get('wlmerchant_order', array('id' => $id), array('num', 'specid'));

				if ($order['specid']) {
					pdo_fetch('update' . tablename('wlmerchant_goods_option') . ('SET stock=stock+' . $order['num'] . ' WHERE id = ' . $order['specid']));
				}
			}
		}
		else {
			$res = pdo_update('wlmerchant_rush_order', array('status' => 5), array('id' => $id));

			if ($res) {
				$order = pdo_get('wlmerchant_rush_order', array('id' => $id), array('num', 'optionid'));

				if ($order['optionid']) {
					pdo_fetch('update' . tablename('wlmerchant_goods_option') . ('SET stock=stock+' . $order['num'] . ' WHERE id = ' . $order['optionid']));
				}
			}
		}

		if ($res) {
			show_json(1);
		}
		else {
			show_json(0, 'å®æå¤±è´¥ï¼è¯·å·æ°éè¯');
		}
	}

	public function remarksaler()
	{
		global $_W;
		global $_GPC;
		$id = $_GPC['id'];
		$type = $_GPC['type'];

		if ($type == 'a') {
			$remark = pdo_getcolumn(PDO_NAME . 'order', array('id' => $id), 'remark');
		}
		else {
			$remark = pdo_getcolumn(PDO_NAME . 'rush_order', array('id' => $id), 'adminremark');
		}

		if ($_W['ispost']) {
			$newremark = trim($_GPC['remark']);

			if ($type == 'a') {
				$res = pdo_update('wlmerchant_order', array('remark' => $newremark), array('id' => $id));
			}
			else {
				$res = pdo_update('wlmerchant_rush_order', array('adminremark' => $newremark), array('id' => $id));
			}

			if ($res) {
				show_json(1);
			}
			else {
				show_json(0, 'å¤æ³¨å¤±è´¥ï¼è¯·å·æ°éè¯');
			}
		}

		include wl_template('order/remarksaler');
	}

	public function createdisorder()
	{
		global $_W;
		global $_GPC;
		$id = $_GPC['id'];
		$type = $_GPC['type'];

		if ($type == 'a') {
			$order = pdo_get('wlmerchant_order', array('id' => $id), array('fkid', 'mid', 'expressid', 'price', 'plugin', 'specid', 'num', 'vipbuyflag'));

			if ($order['plugin'] == 'groupon') {
				$plugin = 'groupon';
				$goods = pdo_get('wlmerchant_groupon_activity', array('id' => $order['fkid']), array('dissettime', 'onedismoney', 'twodismoney', 'viponedismoney', 'viptwodismoney'));

				if ($order['specid']) {
					$option = pdo_get('wlmerchant_goods_option', array('id' => $order['specid']), array('onedismoney', 'twodismoney', 'threedismoney'));
					$onemoney = sprintf('%.2f', $option['onedismoney'] * $order['num']);
					$twomoney = sprintf('%.2f', $option['twodismoney'] * $order['num']);
				}
				else if ($order['vipbuyflag']) {
					$onemoney = sprintf('%.2f', $goods['viponedismoney'] * $order['num']);
					$twomoney = sprintf('%.2f', $goods['viptwodismoney'] * $order['num']);
				}
				else {
					$onemoney = sprintf('%.2f', $goods['onedismoney'] * $order['num']);
					$twomoney = sprintf('%.2f', $goods['twodismoney'] * $order['num']);
				}
			}
			else if ($order['plugin'] == 'wlfightgroup') {
				$plugin = 'fightgroup';
				$goods = pdo_get('wlmerchant_fightgroup_goods', array('id' => $order['fkid']), array('dissettime', 'onedismoney', 'twodismoney'));
				$onemoney = sprintf('%.2f', $goods['onedismoney'] * $order['num']);
				$twomoney = sprintf('%.2f', $goods['twodismoney'] * $order['num']);
			}
			else if ($order['plugin'] == 'coupon') {
				$plugin = 'coupon';
				$goods = pdo_get('wlmerchant_couponlist', array('id' => $order['fkid']), array('dissettime', 'onedismoney', 'twodismoney', 'viponedismoney', 'viptwodismoney'));

				if ($order['vipbuyflag']) {
					$onemoney = sprintf('%.2f', $goods['viponedismoney'] * $order['num']);
					$twomoney = sprintf('%.2f', $goods['viptwodismoney'] * $order['num']);
				}
				else {
					$onemoney = sprintf('%.2f', $goods['onedismoney'] * $order['num']);
					$twomoney = sprintf('%.2f', $goods['twodismoney'] * $order['num']);
				}
			}
			else {
				if ($order['plugin'] == 'bargain') {
					$plugin = 'bargain';
					$goods = pdo_get('wlmerchant_bargain_activity', array('id' => $order['fkid']), array('dissettime', 'onedismoney', 'twodismoney', 'viponedismoney', 'viptwodismoney'));

					if ($order['vipbuyflag']) {
						$onemoney = sprintf('%.2f', $goods['viponedismoney'] * $order['num']);
						$twomoney = sprintf('%.2f', $goods['viptwodismoney'] * $order['num']);
					}
					else {
						$onemoney = sprintf('%.2f', $goods['onedismoney'] * $order['num']);
						$twomoney = sprintf('%.2f', $goods['twodismoney'] * $order['num']);
					}
				}
			}
		}
		else {
			$order = pdo_get('wlmerchant_rush_order', array('id' => $id), array('activityid', 'mid', 'expressid', 'optionid', 'actualprice', 'num', 'vipbuyflag'));
			$order['price'] = $order['actualprice'];
			$plugin = 'rush';
			$goods = pdo_get('wlmerchant_rush_activity', array('id' => $order['activityid']), array('dissettime', 'onedismoney', 'twodismoney', 'viponedismoney', 'viptwodismoney'));

			if ($order['optionid']) {
				$option = pdo_get('wlmerchant_goods_option', array('id' => $order['optionid']), array('onedismoney', 'twodismoney', 'threedismoney'));
				$onemoney = sprintf('%.2f', $option['onedismoney'] * $order['num']);
				$twomoney = sprintf('%.2f', $option['twodismoney'] * $order['num']);
			}
			else if ($order['vipbuyflag']) {
				$onemoney = sprintf('%.2f', $goods['viponedismoney'] * $order['num']);
				$twomoney = sprintf('%.2f', $goods['viptwodismoney'] * $order['num']);
			}
			else {
				$onemoney = sprintf('%.2f', $goods['onedismoney'] * $order['num']);
				$twomoney = sprintf('%.2f', $goods['twodismoney'] * $order['num']);
			}
		}

		$distributorid = pdo_getcolumn(PDO_NAME . 'member', array('uniacid' => $_W['uniacid'], 'id' => $order['mid']), 'distributorid');

		if (empty($distributorid)) {
			show_json(0, 'è¯¥ç¨æ·æ åéä¸çº§ï¼æ æ³çæåéè®¢å');
		}
		else {
			$distributor = pdo_get(PDO_NAME . 'distributor', array('uniacid' => $_W['uniacid'], 'id' => $distributorid), array('leadid', 'disflag', 'dislevel'));

			if ($distributor['disflag']) {
				$mleveid = $distributor['dislevel'];

				if (empty($mleveid)) {
					$mleveid = pdo_getcolumn('wlmerchant_dislevel', array('uniacid' => $_W['uniacid'], 'isdefault' => 1), 'id');
				}

				$memberlevel = pdo_get(PDO_NAME . 'dislevel', array('id' => $mleveid), array('ownstatus'));
			}

			if ($distributor['leadid'] < 0 && empty($memberlevel['ownstatus'])) {
				show_json(0, 'è¯¥ç¨æ·æ åéä¸çº§ï¼æ æ³çæåéè®¢å');
			}
		}

		if ($order['expressid']) {
			$expprice = pdo_getcolumn(PDO_NAME . 'express', array('uniacid' => $_W['uniacid'], 'id' => $order['expressid']), 'expressprice');
			$price = sprintf('%.2f', $order['price'] - $expprice);
		}
		else {
			$price = $order['price'];
		}

		if (empty($plugin)) {
			show_json(0, 'è®¢åæä»¶éè¯¯ï¼è¯·èç³»ç®¡çå');
		}

		$disorderid = Distribution::disCore($order['mid'], $price, $onemoney, $twomoney, 0, $id, $plugin, $goods['dissettime']);

		if ($disorderid) {
			if ($type == 'a') {
				$res = pdo_update('wlmerchant_order', array('disorderid' => $disorderid), array('id' => $id));
			}
			else {
				$res = pdo_update('wlmerchant_rush_order', array('disorderid' => $disorderid), array('id' => $id));
			}

			if ($res) {
				show_json(1);
			}
			else {
				show_json(0, 'å³èåéè®¢åå¤±è´¥ï¼è¯·èç³»ç®¡çå');
			}
		}
		else {
			show_json(0, 'è¯¥è®¢åæ æ³çæåéè®¢åã');
		}
	}

	/**
     * Comment: æ ¹æ®æ¡ä»¶è·åè®¢åä¿¡æ¯
     * Author: zzw
     * @param $where   æ¡ä»¶ä¸ æ¥è¯¢rush_orderè¡¨ä½¿ç¨
     * @param $where2  æ¡ä»¶äº æ¥è¯¢orderè¡¨ä½¿ç¨
     * @return array
     */
	static protected function getOrderInfo($where, $where2, $limit)
	{
		$sql = 'SELECT a.id,a.mobile,a.createtime,a.sid,a.status,a.paidprid,a.mid,a.orderno,a.num,a.price,a.paytype,a.vipbuyflag,a.paytime,a.changedispatchprice,a.changeprice,a.disorderid,a.applyrefund, "a",
            f.qrcode as fqrcode,
            g.qrcode as gqrcode,
            `c`.concode as cqrcode,
            b.qrcode as bqrcode FROM ' . tablename(PDO_NAME . 'order') . ' a LEFT JOIN ' . tablename(PDO_NAME . 'fightgroup_userecord') . ' f ON a.id = f.orderid AND a.plugin = \'wlfightgroup\'' . ' LEFT JOIN ' . tablename(PDO_NAME . 'groupon_userecord') . ' g ON a.id = g.orderid AND a.plugin = \'groupon\'' . ' LEFT JOIN ' . tablename(PDO_NAME . 'member_coupons') . ' `c` ON a.orderno = `c`.orderno AND a.plugin = \'coupon\'' . ' LEFT JOIN ' . tablename(PDO_NAME . 'bargain_userlist') . (' b ON a.id = b.orderid AND a.plugin = \'bargain\' ' . $where2 . ' ') . ' UNION ALL SELECT id,mobile,createtime,sid,status,paidprid,mid,orderno,num,price,paytype,vipbuyflag,paytime,changedispatchprice,changeprice,disorderid,applyrefund, "b","rush","rush","rush","rush" FROM ' . tablename(PDO_NAME . 'rush_order') . (' ' . $where . ' ORDER BY createtime DESC ' . $limit);
		$orderlist = pdo_fetchall($sql);
		return $orderlist;
	}

	public function orderset()
	{
		global $_W;
		global $_GPC;
		$settings = Setting::wlsetting_read('orderset');
		$settings['plugin'] = unserialize($settings['plugin']);

		if (checksubmit('submit')) {
			$base = Util::trimWithArray($_GPC['shop']);
			$base['plugin'] = serialize($_GPC['plugin']);
			Setting::wlsetting_save($base, 'orderset');
			wl_message('æ´æ°è®¾ç½®æåï¼', web_url('order/wlOrder/orderset'));
		}

		include wl_template('order/orderset');
	}

	/**
     * Comment: å¨å­æ¹éåè´§ç.cvsæä»¶  ç¶åè¿åæä»¶åç§°
     * Author: zzw
     */
	public function bulkShipment()
	{
		global $_W;
		global $_GPC;
		$imageName = 'excel' . time() . rand(1000, 9999) . '.csv';
		$imageName = 'images/' . MODULE_NAME . '/' . $imageName;
		$fullName = PATH_ATTACHMENT . $imageName;
		$res = move_uploaded_file($_FILES['file']['tmp_name'], $fullName);

		if (!$res) {
			wl_json(0, 'æä½å¤±è´¥ï¼æä»¶ä¸ä¼ éè¯¯');
		}

		wl_json(1, 'æä»¶ä¸ä¼ æå,æ­£å¨å¤çä¿¡æ¯...', $imageName);
	}

	/**
     * Comment: æ¹éåè´§ å¹¶ä¸è¿åç»æä¿¡æ¯è¡¨
     * Author: zzw
     */
	public function batchSend()
	{
		global $_W;
		global $_GPC;
		$name = $_GPC['name'];
		$fullName = PATH_ATTACHMENT . $name;
		$info = util_csv::read_csv_lines($fullName, 999, 0);
		unlink($fullName);

		foreach ($info as $k => &$v) {
			if (!is_array($v)) {
				unset($info[$k]);
				continue;
			}

			$separator = '*separator*';
			$v = explode($separator, iconv('gbk', 'utf-8', implode($separator, $v)));

			if (trim($v[8]) != 'å¾æ¶è´§') {
				$v['send_result'] = 'ä¸è¿è¡åè´§æä½';
				continue;
			}

			$orderType = trim($v[1]);
			$orderId = trim($v[21]);
			$expressName = trim($v[17]);
			$expressNum = trim($v[18]);
			$sendResult = 'åè´§æå';

			if ($orderType == 'æ¢è´­') {
				$expressId = pdo_getcolumn(PDO_NAME . 'rush_order', array('id' => $orderId), 'expressid');
			}
			else {
				if ($orderType == 'æ¼å¢' || $orderType == 'å¢è´­' || $orderType == 'å¡å¸' || $orderType == 'ç ä»·') {
					$expressId = pdo_getcolumn(PDO_NAME . 'order', array('id' => $orderId), 'expressid');
				}
				else {
					$sendResult = 'åè´§å¤±è´¥,ä»æ¯ææ¢è´­ãæ¼å¢ãå¢è´­ãå¡å·ãç ä»·ååçæ¹éåè´§';
				}
			}

			$logistics = array('é¡ºä¸°' => 'shunfeng', 'ç³é' => 'shentong', 'éµè¾¾å¿«è¿' => 'yunda', 'å¤©å¤©å¿«é' => 'tiantian', 'åééé' => 'yuantong', 'ä¸­ééé' => 'zhongtong', 'emså¿«é' => 'ems', 'æ±éå¿«è¿' => 'huitongkuaidi', 'å¨å³°å¿«é' => 'quanfengkuaidi', 'å®æ¥é' => 'zhaijisong', 'aaeå¨çä¸é' => 'aae', 'å®æ·å¿«é' => 'anjie', 'å®ä¿¡è¾¾å¿«é' => 'anxindakuaixi', 'å½ªè®°å¿«é' => 'biaojikuaidi', 'bht' => 'bht', 'ç¾ç¦ä¸æ¹å½éç©æµ' => 'baifudongfang', 'ä¸­å½ä¸æ¹ï¼COEï¼' => 'coe', 'ä¸­å½ä¸æ¹(COE)' => 'coe', 'é¿å®ç©æµ' => 'changyuwuliu', 'å¤§ç°ç©æµ' => 'datianwuliu', 'å¾·é¦ç©æµ' => 'debangwuliu', 'dhl' => 'dhl', 'dpex' => 'dpex', 'déå¿«é' => 'dsukuaidi', 'éåæ¹' => 'disifang', 'fedexï¼å½å¤ï¼' => 'fedex', 'fedex(å½å¤)' => 'fedex', 'é£åº·è¾¾ç©æµ' => 'feikangda', 'å¤å°å¿«é' => 'fenghuangkuaidi', 'é£å¿«è¾¾' => 'feikuaida', 'å½éå¿«é' => 'guotongkuaidi', 'æ¸¯ä¸­è½è¾¾ç©æµ' => 'ganzhongnengda', 'å¹¿ä¸é®æ¿ç©æµ' => 'guangdongyouzhengwuliu', 'å±éè¾¾' => 'gongsuda', 'æè·¯ç©æµ' => 'hengluwuliu', 'åå¤é¾ç©æµ' => 'huaxialongwuliu', 'æµ·çº¢' => 'haihongwangsong', 'æµ·å¤ç¯ç' => 'haiwaihuanqiu', 'ä½³æ¡ç©æµ' => 'jiayiwuliu', 'äº¬å¹¿éé' => 'jinguangsudikuaijian', 'æ¥åè¾¾' => 'jixianda', 'ä½³åç©æµ' => 'jjwl', 'å è¿ç¾ç©æµ' => 'jymwl', 'éå¤§ç©æµ' => 'jindawuliu', 'åéå¤§é' => 'jialidatong', 'æè¶å¿«é' => 'jykd', 'å¿«æ·éé' => 'kuaijiesudi', 'èé¦å¿«éï¼å½åï¼' => 'lianb', 'èé¦å¿«é(å½å)' => 'lianb', 'èæéç©æµ' => 'lianhaowuliu', 'é¾é¦ç©æµ' => 'longbanwuliu', 'ç«å³é' => 'lijisong', 'ä¹æ·é' => 'lejiedi', 'æ°èªå¿«é' => 'minghangkuaidi', 'ç¾å½å¿«é' => 'meiguokuaidi', 'é¨å¯¹é¨' => 'menduimen', 'OCS' => 'ocs', 'éæè´§è¿' => 'peisihuoyunkuaidi', 'å¨æ¨å¿«é' => 'quanchenkuaidi', 'å¨ééç©æµ' => 'quanjitong', 'å¨æ¥éå¿«é' => 'quanritongkuaidi', 'å¨ä¸å¿«é' => 'quanyikuaidi', 'å¦é£è¾¾' => 'rufengda', 'ä¸æéé' => 'santaisudi', 'çè¾ç©æµ' => 'shenghuiwuliu', 'éå°ç©æµ' => 'sue', 'çä¸°ç©æµ' => 'shengfeng', 'èµæ¾³é' => 'saiaodi', 'å¤©å°åå®' => 'tiandihuayu', 'tnt' => 'tnt', 'ups' => 'ups', 'ä¸å®¶ç©æµ' => 'wanjiawuliu', 'ææ·èªç©ºéé' => 'wenjiesudi', 'ä¼å' => 'wuyuan', 'ä¸è±¡ç©æµ' => 'wxwl', 'æ°é¦ç©æµ' => 'xinbangwuliu', 'ä¿¡ä¸°ç©æµ' => 'xinfengwuliu', 'äºé£éé' => 'yafengsudi', 'ä¸é¦éé' => 'yibangwuliu', 'ä¼éç©æµ' => 'youshuwuliu', 'é®æ¿åè£¹æå·ä¿¡' => 'youzhengguonei', 'é®æ¿å½éåè£¹æå·ä¿¡' => 'youzhengguoji', 'è¿æç©æµ' => 'yuanchengwuliu', 'æºä¼ä¸°å¿«é' => 'yuanweifeng', 'åæºæ·è¯å¿«é' => 'yuanzhijiecheng', 'è¿éå¿«é' => 'yuntongkuaidi', 'è¶ä¸°ç©æµ' => 'yuefengwuliu', 'æºå®è¾¾' => 'yad', 'é¶æ·éé' => 'yinjiesudi', 'ä¸­éå¿«è¿' => 'zhongtiekuaiyun', 'ä¸­é®ç©æµ' => 'zhongyouwuliu', 'å¿ ä¿¡è¾¾' => 'zhongxinda', 'èéº»å¼é¨' => 'zhimakaimen');
			$expressEName = $logistics[$expressName];

			if (!$expressEName) {
				$sendResult = 'ä¸æ¯æä½¿ç¨å½åå¿«éå¬å¸åè´§!';
			}

			if ($expressName && $expressId) {
				$expressDate['expressname'] = $expressEName;
				$expressDate['expresssn'] = $expressNum;
				$expressDate['orderid'] = $orderId;
				$expressDate['sendtime'] = time();
				$updateRes = pdo_update(PDO_NAME . 'express', $expressDate, array('id' => $expressId));

				if ($orderType == 'æ¢è´­') {
					$UstateRes = pdo_update(PDO_NAME . 'rush_order', array('status' => 4), array('id' => $orderId));
					Message::sendremind($orderId, 'b');
				}
				else {
					if ($orderType == 'æ¼å¢' || $orderType == 'å¢è´­' || $orderType == 'å¡å¸' || $orderType == 'ç ä»·') {
						$UstateRes = pdo_update(PDO_NAME . 'order', array('status' => 4), array('id' => $orderId));
						Message::sendremind($orderId, 'a');
					}
				}

				if ($updateRes && $UstateRes) {
					$sendResult = 'åè´§æå';
				}
				else {
					$sendResult = 'åè´§å¤±è´¥ï¼è¯·æ£æ¥ä¿¡æ¯æ¯å¦å¡«åæ­£ç¡®ææ¯å¦å·²åè´§!';
				}
			}

			$v['send_result'] = $sendResult;
		}

		$filter = array(0 => 'è®¢åå·', 1 => 'æå±åºç¨', 2 => 'åååç§°', 3 => 'è§æ ¼åç§°', 4 => 'æ°é', 5 => 'æå±åå®¶', 6 => 'ä¹°å®¶æµç§°', 7 => 'ä¹°å®¶çµè¯', 8 => 'è®¢åç¶æ', 9 => 'æ¯ä»æ¹å¼', 10 => 'ä¸åæ¶é´', 11 => 'æ¯ä»æ¶é´', 12 => 'å®ä»éé¢', 13 => 'å¤æ³¨', 14 => 'æ¶è´§äººå§å', 15 => 'æ¶è´§äººçµè¯', 16 => 'æ¶è´§äººå°å', 17 => 'ç©æµå¬å¸', 18 => 'å¿«éåå·', 19 => 'æ ¸éæ¶é´', 20 => 'æ ¸éå', 21 => 'è®¢åid', 'send_result' => 'åè´§ç»æ');
		util_csv::export_csv_2($info, $filter, 'æ¹éåè´§ç»æä¿¡æ¯.csv');
	}
}

defined('IN_IA') || exit('Access Denied');

?>
